*** Settings ***
Documentation     Reusable Library for access to databases 
...               Precondition - None

Library		OperatingSystem    
Library		SSHLibrary
Library		BuiltIn
Library		String
Library		Collections
Library         DateTime

*** Variables ***
${VLDB_HOSTIP}=                                 10.248.33.34


*** Keywords ***

DB2 Get Login and Password
	@{creds}=                               Get DB2 Credentials
	Set Suite Variable			${HOST_DB2SERVER}			%{db2_IP}
	Set Suite Variable			${DB2USERNAME}				@{creds}[0]
	Set Suite Variable			${DB2PASSWORD}				@{creds}[1]
	
Pause Get Login and Password
	@{creds}=                               Get Pause Credentials
	Set Suite Variable			${PAUSEIP}				%{pause_IP}
	Set Suite Variable			${PAUSEUSERNAME}			@{creds}[0]
	Set Suite Variable			${PAUSEPASSWORD}			@{creds}[1]

VLDB Get Login and Password
	Set Suite Variable			${VLDBIP}			%{vldb_IP}
	Set Suite Variable			${VLDBUSERNAME}			%{vldb_
	Set Suite Variable			${VLDBPASSWORD}			@{creds}[1]


Fetch VLDB record count                         [Arguments]               ${idn}
        ${idn_prefix}                           Set Variable              idn=
        ${index}=                               Open Connection           ${VLDB_HOSTIP}
        ${output}=                              Login With Public Key     hlouissaint    /home/hlouissaint/.ssh/id_rsa    delay=0.5 seconds
        Should Contain                          ${output}    atl1rhnproxy02.internal.secureworkslab.com        
        ${getdate}                              Execute Command    echo `date +"%Y-%m-%d"`
        Log                                     ${getdate}
        ${internal_device_name}=                Set Variable              ${idn_prefix}${idn.strip()}
        Log                                     ${internal_device_name}
        ${readoutput}    Execute Command    impala-shell -d atl_agile_rawlogs -B --quiet -q "SELECT count(*) rawlog_subsource FROM logs_recent where p_day='${getdate}' and rawlog_subsource = '${internal_device_name}';"
        [Return]          ${readoutput}

Connect To Database
        # Set the profile and environment variables
        Switch Connection       		${PCSIP}
        ${written}=             		Write           . ~db2inst1/sqllib/db2profile
        Should Contain          		${written}      . ~db2inst1/sqllib/db2profile
        ${output}=      			Read
        Set Suite Variable      		${DB2ACTIVE}    True
        # Connect to the data base
        Set Client Configuration        	timeout=60 seconds
        Write   				db2 "connect to sw user db2inst1 using tester"
        ${output}=      			Read Until      Local database alias
        # Use the Database
        Write   				db2 "set schema secureworks"
        ${output}=      			Read    delay=3s
        Should Contain          		${output}       completed successfully

Get Current iSensor Release From PCS
	Switch Connection       		${PCSIP}
	${written}=				Write			db2 -ox "SELECT CURRENT_RELEASE FROM PCSMS.RULESET_SUBSCRIPTION WHERE UIN='${UIN}'"
	${output}=				Read			delay=3s
	${release}=				Get Line		${output}	0
	Set Suite Variable			${RELEASEIVERSION}	${release}

Get Current Available Ruleset Version		[Arguments]		${status}	${category}	${snortv}
	Switch Connection       		${PCSIP}
	${SQL}=					Set Variable		SELECT PKEY FROM PCSMS.RULESET
	${SQL}=					Catenate		${SQL}		WHERE STATUS = ${status} 
	${SQL}=         			Catenate        	${SQL}		AND RULESET_CATEGORY = ${category}
	${SQL}=         			Catenate        	${SQL}		AND SNORT_VERSION = '${snortv}'
	${SQL}=         			Catenate        	${SQL}		ORDER BY CREATE_DATE DESC
	${written}=				Write			db2 -ox "${SQL}"
	${output}=				Read			delay=3s
	${pkey}=				Get Line		${output}	0
	${written}=				Write			db2 -ox "SELECT VERSION FROM PCSMS.RULESET WHERE PKEY = ${pkey}"
	${resp}=				Read			delay=3s
	${version}=				Get Line		${resp}		0
	Set Suite Variable			${RULESETVERSION}	${version.strip()}
	


Get iSensor Information From Database
        # Get database iSensor version
        Switch Connection       	${PCSIP}
        ${written}=                     Write                   db2 -ox "SELECT CURRENT_RELEASE FROM PCSMS.RULESET_SUBSCRIPTION WHERE UIN = '${UIN}'"
        ${idboutput}=                   Read                    delay=3s
        ${idbversion}=                  Get Line                ${idboutput}    0
        Should Not Match Regexp         ${idbversion}           ${SQLFAIL}
        Set Suite Variable              ${DB_ISENSORVERSION}    ${idbversion}

        # Get database snort version
        ${written}=                     Write                   db2 -ox "SELECT CURRENT_SNORT_VERSION FROM PCSMS.RULESET_SUBSCRIPTION WHERE UIN = '${UIN}'"
        ${sdboutput}=                   Read                    delay=3s
        ${sdbversion}=                  Get Line                ${sdboutput}    0
        Should Not Match Regexp         ${sdbversion}           ${SQLFAIL}
        Set Suite Variable              ${DB_SNORTVERSION}      ${sdbversion}

        # Get database ruleset version
        ${written}=                     Write                   db2 -ox "SELECT TARGET_RULESET_CATEGORY FROM PCSMS.RULESET_SUBSCRIPTION WHERE UIN = '${UIN}'"
        ${outpkey}=                     Read                    delay=3s
        Should Not Match Regexp         ${outpkey}              ${SQLFAIL}
        ${rulepkey}=                    Get Line                ${outpkey.strip()}      0
	Set Suite Variable		${DB_RULE_PKEY}		${rulepkey}
        Log                             ${rulepkey}

        ${written}=                     Write                   db2 -ox "SELECT VULNDB_NAME FROM PCSMS.RULESET_CATEGORY WHERE PKEY = ${rulepkey}"
        ${outprof}=                     Read                    delay=3s
        Should Not Match Regexp         ${outprof}              ${SQLFAIL}
        ${ruleprofile}=                 Get Line                ${outprof.strip()}      0
	Set Suite Variable		${DB_VULNDB_NAME}	${ruleprofile}
        Log                             ${ruleprofile}

        ${written}=                     Write                   db2 -ox "SELECT CURRENT_RULESET FROM PCSMS.RULESET_SUBSCRIPTION WHERE UIN = '${UIN}'"
        ${outcurrule}=                  Read                    delay=3s
        Should Not Match Regexp         ${outcurrule}           ${SQLFAIL}
        ${currule}=                     Get Line                ${outcurrule.strip()}   0
	Set Suite Variable		${DB_CURRENT_RULESET}	${currule}
        Log                             ${currule}

        ${written}=                     Write                   db2 -ox "SELECT VERSION FROM PCSMS.RULESET WHERE PKEY = ${currule}"
        ${outrulever}=                  Read                    delay=3s
        Should Not Match Regexp         ${outrulever}           ${SQLFAIL}
        ${ruleversion}=                 Get Line                ${outrulever}		0
	Set Suite Variable		${DB_RS_VERSION}	${ruleversion}
        Log                             ${ruleversion}

        # Get database ruleset version
        ${written}=                     Write                   db2 -ox "SELECT RULESET_CATEGORY FROM PCSMS.RULESET_SUBSCRIPTION WHERE UIN = '${UIN}'"
        ${outpkey}=                     Read                    delay=3s
        Should Not Match Regexp         ${outpkey}              ${SQLFAIL}
        ${catpkey}=			Get Line                ${outpkey.strip()}      0
	Set Suite Variable		${DB_CAT_PKEY}		${catpkey}
        Log                             ${catpkey}

        ${written}=			Write                   db2 -ox "SELECT NAME FROM PCSMS.RULESET_CATEGORY WHERE PKEY = ${DB_CAT_PKEY}"
        ${catname_l}=			Read                    delay=3s
        Should Not Match Regexp         ${catname_l}		${SQLFAIL}
        ${cat_name}=			Get Line                ${catname_l}		0
	Set Suite Variable		${RS_CATEGORY}		${cat_name}
        Log                             ${cat_name}

        ${rdbversion}=  Catenate        SEPARATOR=.             ${ruleprofile.strip()}  ${ruleversion.strip()}
        Set Suite Variable      ${DB_RULESETVERSION}    ${rdbversion}
        Log             ${rdbversion}

Validate iSensor Information With Database Information
        Should Match    ${ISENSORVERSION}       ${DB_ISENSORVERSION.strip()}    ERROR: iSensor Version does not match with database version
        #Run Keyword If                 '${ISENSORVERSION}'=='${DB_ISENSORVERSION.strip()}'             Log             iSensor Version ${DB_ISENSORVERSION.strip()} is valid
        #Run Keyword Unless             '${ISENSORVERSION}'=='${DB_ISENSORVERSION.strip()}'             Log             iSensor Version ${DB_ISENSORVERSION.strip()} is invalid

        Should Match    ${SNORTVERSION} ${DB_SNORTVERSION.strip()}      ERROR: Snort Version does not match with database version
        #Run Keyword If                 '${SNORTVERSION}'=='${DB_SNORTVERSION.strip()}'         Log             Snort Version ${DB_SNORTVERSION.strip()} is valid
        #Run Keyword Unless             '${SNORTVERSION}'=='${DB_SNORTVERSION.strip()}'         Log             Snort Version ${DB_SNORTVERSION.strip()} is invalid

        Should Match    ${RULESETVERSION}       ${DB_RULESETVERSION.strip()}    ERROR: Ruleset Version does not match with database version
        #Run Keyword If                 '${RULESETVERSION}'=='${DB_RULESETVERSION.strip()}'             Log             Ruleset Version ${DB_RULESETVERSION.strip()} is valid
        #Run Keyword Unless             '${RULESETVERSION}'=='${DB_RULESETVERSION.strip()}'             Log             Ruleset Version ${DB_RULESETVERSION.strip()} is invalid

Close Database Connection
        Switch Connection                       ${PCSIP}
        Run Keyword Unless                      ${DB2ACTIVE}==False             Terminate DB2 Session
        Close Connection
        Set Suite Variable                      ${PCSCONNECTED}                 False

Terminate DB2 Session
        Switch Connection       ${PCSIP}
        ${resp}=                Write                   db2 terminate
        ${output}=              Read                    delay=3s
        Should Contain          ${output}               The TERMINATE command completed successfully
        Set Suite Variable      ${DB2ACTIVE}            False


