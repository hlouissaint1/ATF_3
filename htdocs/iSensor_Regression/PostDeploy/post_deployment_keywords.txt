*** Settings ***
Resource                iSensorConfiguration.txt
Library                 SSHLibrary
Library                 OperatingSystem
Library                 BuiltIn
Library                 String
Library                 Collections
Library                 scwxCorelib.ATF         ${TestEnvironment}              ${ATF_User}
Library                 scwxCorelib.Mail         ${TestEnvironment}              ${ATF_User}
Library                 ctpapi2.PCSMS           ${TestEnvironment}              ${ATF_User}
Library                 scwxIMSClib.RCMS        ${TestEnvironment}              ${ATF_User}

*** Variables ***
${SHUN}		242.225.242.225
${HOSTIP}       %{TAF_iSensorMgmtIp}
*** Keywords ***

Push Rulesets To iSensor
        ${ruleset}                      ${category}                             Get Previous Ruleset Subscription                                       ${UIN}          csv=True
        ${new_ruleset}                  ${new_category}=                        Get_Current_Ruleset_Subscription                                        ${UIN}          csv=True
        Run Keyword If                  "${ruleset}"=="${new_ruleset}"          Fatal Error                     Ruleset Subscription Error
        ${result}=                      Deploy Ruleset                          ${category}                     ${ruleset}                              ${UIN}          ${POLICY}
        Should Not Contain              ${result}                               ERROR
        ${new_ruleset}                  ${new_category}=                        Get_Current_Ruleset_Subscription                                        ${UIN}          csv=True
        Run Keyword If                  "${ruleset}"!="${new_ruleset}"          Fatal Error                     Ruleset Failed To Deploy
	Set Test Message		Successfully deployed ruleset ${ruleset}
	Deploy Latest			${new_category}

Execute an RCMSMQTransmit Command
        ${resp}=                        RCMSMQTransmit                          uptime
	${ignore}=			Run Keyword and Return Status		Should Contain			${resp}					Network is unreachable
	Run Keyword If			${ignore}				Pass Execution If		${ignore}				Benign error for now
        Should Not Contain              ${resp}                                 ERROR
        Set Test Message                ${resp}

Add Shuns to iSensor
        ${existing_shun}=               Get Shuns                               search_for=${SHUN}
        Log                                                                     ${existing_shun}
        Should Not Contain              ${existing_shun}                        ERROR
        Run Keyword If                  "${existing_shun}" != ""	        Clear Shun                      ${existing_shun}
        ${resp}=                        Add Shun                                ${UIN}				${SHUN}					protocol=tcp
	Set Test Message		${resp}
        Should Not Contain              ${resp}                                 ERROR
	Sleep				60s
###        ${existing_shun}=               Get Shuns				search_for=${SHUN}
###        Log                                                                     ${existing_shun}
###        Should Not Contain              ${existing_shun}                        ERROR
###        Should Contain                  ${existing_shun}                        ${SHUN}
        Wait Until Keyword Succeeds     360 sec                                 120 sec                           Verify We Can Get The Existing Shun Policy
	Sleep				60s
        Wait Until Keyword Succeeds     360 sec                                 120 sec                           Verify Shun Policy is On the iSensor


Verify Shun Policy is On the iSensor
	${shun_on_box}=                 Get iSensor Shun Policy                 ${SHUN}
	Should Contain			${shun_on_box}                          ${SHUN}


Verify We Can Get The Existing Shun Policy
        ${existing_shun}=               Get Shuns                               search_for=${SHUN}
        Log                                                                     ${existing_shun}
        Should Not Contain              ${existing_shun}                        ERROR
        Should Contain                  ${existing_shun}                        ${SHUN}       


Deploy Previous                         [Arguments]                             ${category}                     ${version}
        ${result}=                      Deploy Ruleset                          ${category}                     ${version}				${UIN}          ${POLICY}
        Should Not Contain              ${result}                               ERROR
        ${ruleset}                      ${new_category}                         ${new_version}=                 Get Current Ruleset Subscription        ${UIN}
        Run Keyword If                  "${new_version}"!="${version}"          Fatal Error                     Ruleset failed to deploy

Deploy Latest                           [Arguments]                             ${category}                     
	${current}			${category}=				Get Current Ruleset Subscription					${UIN}		csv=True
	${latest}=			Get Latest Ruleset Version		${category}			AVAILABLE				${SNORTVERSION}
	Pass Execution If		"${current}"=="${latest}"		iSensor is running on the latest ruleset version
        ${result}=                      Deploy Ruleset                          ${category}                     ${latest}				${UIN}		${POLICY}
        Should Not Contain              ${result}                               ERROR
        ${new_version}                  ${new_category}=	                Get Current Ruleset Subscription        				${UIN}		csv=True
        Run Keyword If                  "${new_version}"!="${latest}"           Fatal Error                     Ruleset failed to deploy

Clear Shun                              [Arguments]                             ${address}
        ${resp}=                        Remove Shun                             ${UIN}				${address}				protocol=tcp
        Should Not Contain              ${resp}                                 ERROR
	Sleep                           60s
###	${existing_shun}=               Get Shuns                               search_for=${address}		
###	Should Not Contain		${existing_shun}			${address}
        Wait Until Keyword Succeeds     360 sec                                 120 sec                           Verify Shun is Removed On iSensor      ${address}
	Sleep                           60s
        Wait Until Keyword Succeeds     360 sec                                 120 sec                           Verify Shun Policy is Not On iSensor    ${address}

Verify Shun Policy is Not On iSensor    [Arguments]                             ${address}
	${shun_on_box}=			Get iSensor Shun Policy			${address}
	Should Not Contain		${shun_on_box}				${address}


Verify Shun is Removed On iSensor       [Arguments]                             ${address}
       ${existing_shun}=               Get Shuns                               search_for=${address}
       Should Not Contain              ${existing_shun}                        ${address}
        

Get iSensor Shun Policy			[Arguments]				${address}
        Switch Connection               ${HOSTIP}
	${filter}=			Set Variable				"^shun_address=.*${address}.*tcp"
	${box_shuns}=			Execute Command				 cat /secureworks/cm/isensor/firewall/shuns/swconfig/config |pcregrep ${filter} 
        Log                             ${box_shuns}
	[Return]			${box_shuns}

	
