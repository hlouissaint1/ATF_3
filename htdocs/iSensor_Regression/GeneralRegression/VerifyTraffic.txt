*** Settings ***
Documentation     Reusable Library to validate the traffic generation via Breaking Point
...               Precondition - None
...               Revisions - Author: Virtusa Team Date: 03/12/2015 Descriptions: Created 0.1

Resource	resource_keywords.txt
Library		OperatingSystem    
Library		SSHLibrary
Library		BuiltIn
Library		String
Library		Collections


*** Variables ***
${HOSTIP}		%{TAF_iSensorMgmtIp}

*** Keywords ***

Get Initial Traffic Statistics
	Get Packet Forwarding Info
	Variable Should Exist		${PFWD}				Unable to determine packet forward configuration
	Run Keyword If			"${PFWD}"=="dpdk"		Get Initial DPDK Information
	Run Keyword If			"${PFWD}"=="ipq3"		Get Initial IPQ3 Information
	
Verify Traffic Generated
        Get Packet Forwarding Info
        Run Keyword If                  "${PFWD}"=="dpdk"               Verify Traffic Generated in DPDK
        Run Keyword If                  "${PFWD}"=="ipq3"               Verify Traffic Generated in IPQ3
	
		
Get Traffic Metrics			[Arguments]			${metric}
	Get Packet Forwarding Info
	Sleep				10s
	${ret_metrics}=			Get Packet Metrics		${metric}			${PFWD}
	[Return]			${ret_metrics}	


Get Initial Packet Information
	Sleep                           10s
	Get Packet Forwarding Info
	${pkt_stats}=                   Run Keyword If                  "${PFWD}"=="ipq3"               Execute Command                 cat /proc/net/ipq3
	${pkt_stats}=                   Run Keyword If                  "${PFWD}"=="dpdk"               Execute Command                 cat /secureworks/stats/dptd

	Set Suite Variable		${TRAF_SNAPSHOT}		${pkt_stats}
	Log				${TRAF_SNAPSHOT}
	Set Test Message		${TRAF_SNAPSHOT}		append=True

	Run Keyword If			"${PFWD}"=="dpdk"		Set Test Variable		${metric}			Number of queues
	Run Keyword If			"${PFWD}"=="ipq3"		Set Test Variable		${metric}			Number of rings,Num of public rings,Max rings
	${ring_metrics}=                Get Packet Metrics		${metric}			${PFWD}
	Set Suite Variable		${INIT_RING_METRICS}		${ring_metrics}

        Run Keyword If                  "${PFWD}"=="dpdk"               Set Test Variable               ${metric}                       Packets autov
        Run Keyword If                  "${PFWD}"=="ipq3"               Set Test Variable               ${metric}                       Cdev major num,Packets autov

	${cdev_autov_metrics}=		Get Packet Metrics		${metric}			${PFWD}
	Set Suite Variable              ${INIT_CDEV_AUTOV}		${cdev_autov_metrics}

	Run Keyword If			"${PFWD}"=="dpdk"		Set Test Variable		${metric}			Packets dropped
	Run Keyword If			"${PFWD}"=="ipq3"		Set Test Variable		${metric}			Packets dropped,Packets bypassed

	${static_pkt_metrics}=		Get Packet Metrics		${metric}			${PFWD}
	Set Suite Variable		${INIT_STATIC_PKT_METRICS}	${static_pkt_metrics}

	${packet_metrics}=		Get Packet Metrics		Packets in,Packets out		${PFWD}
	Set Suite Variable              ${INIT_PACKET_METRICS}		${packet_metrics}

Get Final Packet Information
	Sleep                           10s
	${pkt_stats}=			Run Keyword If			"${PFWD}"=="ipq3"		Execute Command			cat /proc/net/ipq3
	${pkt_stats}=			Run Keyword If			"${PFWD}"=="dpdk"		Execute Command			cat /secureworks/stats/dptd
	Set Suite Variable		${TRAF_SNAPSHOT}		${pkt_stats}
	Log				${TRAF_SNAPSHOT}
	Set Test Message		${TRAF_SNAPSHOT}		append=True
	${ring_metrics}=                Get Packet Metrics		${INIT_RING_METRICS}		${PFWD}
	Set Suite Variable              ${FINAL_RING_METRICS}		${ring_metrics}

	${cdev_autov_metrics}=		Get Packet Metrics		${INIT_CDEV_AUTOV}		${PFWD}
	Set Suite Variable              ${FINAL_CDEV_AUTOV}		${cdev_autov_metrics}
	
	${static_pkt_metrics}=		Get Packet Metrics		${INIT_STATIC_PKT_METRICS}	${PFWD}
	Set Suite Variable		${FINAL_STATIC_PKT_METRICS}	${static_pkt_metrics}

	${packet_count}=		Get Packet Metrics		Packets in,Packets out		${PFWD}
	Log				${packet_count},${INIT_PACKET_METRICS}

	${packet_metrics}=		Get Packet Metrics		${INIT_PACKET_METRICS}		${PFWD}
	Set Suite Variable              ${FINAL_PACKET_METRICS}		${packet_metrics}


Verify Traffic Generated in IPQ3
	Run Keyword If		'${FINAL_PACKET_METRICS}'!='Packets in:+0,Packets out:+0'
	...			Log				Traffic being generated...
	...			ELSE
	...			Log				Traffic is not generated...
	Should Contain		${FINAL_RING_METRICS}		Number of rings:+0,Num of public rings:+0,Max rings:+0
#	Should Contain		${FINAL_CDEV_AUTOV}		Cdev major num:+0,Packets autov:+0
	Should Contain		${FINAL_STATIC_PKT_METRICS}	Packets dropped:+0,Packets bypassed:+0
	Should Not Contain	${FINAL_PACKET_METRICS}		Packets in:+0		No traffic going into the iSensor
	Should Not Contain	${FINAL_PACKET_METRICS}		Packets out:+0		No traffic passing through the iSensor
	
Verify Traffic Generated in DPDK 
	Run Keyword If		'${FINAL_PACKET_METRICS}'!='Packets in:+0,Packets out:+0'
	...			Log				Traffic being generated...
	...			ELSE
	...			Log				Traffic is not generated...
#	Should Contain		${FINAL_CDEV_AUTOV}		Packets autov:+0
	Should Contain		${FINAL_STATIC_PKT_METRICS}	Packets dropped:+0
	Should Not Contain	${FINAL_PACKET_METRICS}		Packets in:+0		No traffic going into the iSensor
	Should Not Contain	${FINAL_PACKET_METRICS}		Packets out:+0		No traffic passing through the iSensor
