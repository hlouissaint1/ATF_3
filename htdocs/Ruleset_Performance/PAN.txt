Documentation         # Test Case for Ruleset Performance Security Category

*** Settings ***

Library                 OperatingSystem
Library                 BuiltIn
Library                 DateTime
Library                 String
Library                 scwxCorelib.Mail                ${TestEnvironment}      ${ATF_User}
Library                 scwxPANlib.PAN                  ${TestEnvironment}      ${ATF_User}     ${VarFile}
Library                 scwxBPlib2.BreakingPoint        ${TestEnvironment}      ${ATF_User}     ${VarFile}
Resource                resource_keywords_PAN.txt
Suite Setup             Reserve Resources               Breaking Point
Suite Teardown          Wrap Up

*** Setting ***
Variables               scwxPANlib.py

*** Variables ***
${MIN_THROUGHPUT_PA3000}        470.000
${MIN_THROUGHPUT_PA500}         20.000
${MAX_LATENCY_PA3000}           2000.000
${MAX_LATENCY_PA500}            3000.00
${MAX_DROPPED_PACKETS_500}      5
${MAX_DROPPED_PACKETS_3000}     40
${DOCROOT}                      /var/www/html/atfweb
${NO_DATA}                      Value is not available due to error occuring in previous step
${PERFORMANCE_RESULTS}          ${NO_DATA}
${DROPPED_PACKETS}              ${NO_DATA}
${THREAT_COUNTS}                ${NO_DATA}
${CPU_AVG_LOADS}                ${NO_DATA}
${CPU_MAX_LOADS}                ${NO_DATA}
${PAN_STATS}                    ${NO_DATA}
${CPU_MAX_LOADS_DETAILS}        ${NO_DATA}
${CPU_AVG_LOADS_DETAILS}        ${NO_DATA}
${MAX_SESSION_CNT}              ${NO_DATA}
${DEVICE_STABLE}                Unknown
${MAX_DROPPED_PACKETS}          ${NO_DATA}
${CAUSE_OF_FAILURE}             Unknown
${SHA256}                       N/A
${RULESET_DIFFS}                ${EMPTY}


*** Test Case ***


Get Current PAN Device Information              [Documentation]                         PAN device under test info
        ${info}=                                Get PAN Info
        Report                                  ${info}
        ${model}=                               Get_PAN_Info                            model                                   True
        Set Suite Variable                      ${PAN_MODEL}                            ${model}
        Set Suite Variable                      ${BASE_RULESET}                         ${targetRuleset}
        Run Keyword If                          "${PAN_MODEL}"=="PA-500"                Use Small Ruleset
        Log                                     Model: "${PAN_MODEL}" under test
        Log                                     ${VarFile}

Get Current Ruleset Version On PAN Device       [Documentation]                         Identifies the ruleset version
        ${version}=                             Get PAN Ruleset Version
        Report                                  *HTML* <p>Version <b>${version}</b> will be replaced with:</p><p><b> ${targetRuleset}</b></p>
        Set Suite Variable                      ${FIRST}                                ${version}
        Set Suite Variable                      ${SECOND}                               ${targetRuleset}



Get Ruleset RC From GitHub
        ${success}=                             Run Keyword and Return Status           Get PAN Ruleset RC      ${targetRuleset}
        Run Keyword Unless                      ${success}                              Set Suite Variable      ${CAUSE_OF_FAILURE}     Unable to retrieve PAN release candidate ruleset
        Run Keyword Unless                      ${success}                              Fatal Error             Unable to retrieve PAN release candidate ruleset
        Run Keyword If                          ${success}                              Report                  version ${targetRuleset} successfully downloaded from Github
        ${release_notes}=                       Get PAN Ruleset Release Notes           ${targetRuleset}
        ${success}=                             Run Keyword and Return Status           Should Not Contain      ${release_notes}        does not exist
        Run Keyword Unless                      ${success}                              Set Suite Variable      ${CAUSE_OF_FAILURE}     Unable to download release Notes
        Run Keyword Unless                      ${success}                              Fatal Error             Unable to download release Notes
        Set Suite Variable                      ${RULESET_DIFFS}                        ${release_notes}
        Report                                  Release Notes: ${release_notes}
        ${shasum}=                              Validate_PAN_Ruleset                    ${targetRuleset}
        ${valid}=                               Run Keyword and Return Status           Should Not Contain      ${shasum}               ERROR
        Run Keyword Unless                      ${valid}                                Set Suite Variable      ${CAUSE_OF_FAILURE}     SHA256 sums do not match
        Run Keyword Unless                      ${valid}                                Fatal Error             SHA256 sums do not match
        Set Suite Variable                      ${SHA256}                               ${shasum}


Remove Any PAN Locks
        ${resp}=                                Remove All Locks
        Report                                  ${resp}
        ${success}=                             Run Keyword and Return Status           Should Not Contain                      ${resp}                 ERROR
        Run Keyword Unless                      ${success}                              Set Suite Variable                     ${CAUSE_OF_FAILURE}      Error removing PAN locks
        Run Keyword Unless                      ${success}                              Fatal Error                             Error removing PAN locks
        Run Keyword If                          ${success}                              Report                                  All locks successfully removed

Set Config Lock
        ${resp}=                                Set PAN Config Lock
        ${success}=                             Run Keyword and Return Status           Should Not Contain                      ${resp}                 ERROR
        Run Keyword Unless                      ${success}                              Set Suite Variable                     ${CAUSE_OF_FAILURE}      Failed to set PAN lock
        Run Keyword Unless                      ${success}                              Fatal Error                             Failed to set PAN lock
        Run Keyword If                          ${success}                              Report                                  Successfully set PAN lock

Set Commit Lock
        ${resp}=                                Set PAN Commit Lock
        ${success}=                             Run Keyword and Return Status           Should Not Contain                      ${resp}                 ERROR
        Run Keyword Unless                      ${success}                              Set Suite Variable                      ${CAUSE_OF_FAILURE}     Failed to set PAN Commit lock
        Run Keyword Unless                      ${success}                              Fatal Error                             Failed to set PAN Commit lock
        Run Keyword If                          ${success}                              Report                                  Successfully set PAN Commit lock

Save Current Config on PAN Device
        ${resp}=                                Save PAN Config
        ${success}=                             Run Keyword and Return Status           Should Not Contain                      ${resp}                 ERROR
        Run Keyword Unless                      ${success}                              Set Suite Variable                      ${CAUSE_OF_FAILURE}     Failed to save PAN config
        Run Keyword Unless                      ${success}                              Fatal Error                             Failed to save PAN config
        Run Keyword If                          ${success}                              Report                                  Successfully saved PAN config

Import Release Candidate int Pan Device
        ${resp}=                                Import PAN Ruleset
        ${success}=                             Run Keyword and Return Status           Should Not Contain                      ${resp}                 ERROR
        Run Keyword Unless                      ${success}                              Set Suite Variable                      ${CAUSE_OF_FAILURE}     Failed to import candidate ruleset
        Run Keyword Unless                      ${success}                              Fatal Error                             Failed to import candidate ruleset
        Run Keyword If                          ${success}                              Report                                  Successfully imported candidate ruleset

Load Release Candidate
        ${resp}=                                Load Local PAN XML File
        ${success}=                             Run Keyword and Return Status           Should Not Contain                      ${resp}                 ERROR
        Run Keyword Unless                      ${success}                              Set Suite Variable                      ${CAUSE_OF_FAILURE}     Failed to load candidate ruleset
        Run Keyword Unless                      ${success}                              Fatal Error                             Failed to load candidate ruleset
        Run Keyword If                          ${success}                              Report                                  Successfully loaded candidate ruleset

Commit the Release Candidate
        ${jobid}=                               PAN Commit RC
        ${success}=                             Run Keyword and Return Status           Should Not Contain                      ${jobid}                 ERROR
        Run Keyword Unless                      ${success}                              Set Suite Variable                      ${CAUSE_OF_FAILURE}      Failed to commit candidate ruleset
        Run Keyword Unless                      ${success}                              Fatal Error                             Failed to commit candidate ruleset
        Run Keyword If                          ${success}                              Report                                  Successfully committed candidate ruleset
        Set Suite Variable                      ${COMMIT_JOB_ID}                        ${jobid}

Wait For Commit Job Completion
        ${resp}=                                Wait For Successful Commit              ${COMMIT_JOB_ID}                        1500
        ${success}=                             Run Keyword and Return Status           Should Not Contain                      ${resp}                                 ERROR
        Run Keyword Unless                      ${success}                              Fatal Error                             Failed to track job commit
        ${success}=                             Run Keyword and Return Status           Should Not Contain                      ${resp}                                 timed out
        Run Keyword Unless                      ${success}                              Fatal Error                             Commit job timed out
        Run Keyword If                          ${success}                              Report                                  Commit job completed successfully


Verify PAN Device Is On New Version
        ${version}=                             Get PAN Ruleset Version
        ${match}=                               Compare PAN Ruleset Versions            ${version}                              ${targetRuleset}
        #Run Keyword Unless                      ${match}                                Fatal Error                             PAN device does not have target ruleset
        Report                                  ${version}

Run Traffic Thru the PAN Device and Verify Performance
        #${pretraffic_resources}=                Get_PAN_Resources
        #Report                                  ${pretraffic_resources}
        #${swap}=                                Get_PAN_Resources                       swap                    cached          limit=1.0
        ${datestr}                              ${timestamp}=                           Get PAN Time
        Set Suite Variable                      ${STARTTIME}                            ${timestamp}
        Report                                  PAN device time:${datestr} (${STARTTIME})
        Wait Until Keyword Succeeds             30m                                     30                      Check If CPU Has Normalized
        Run Benign Performance Traffic
        #${posttraffic_resources}=               Get_PAN_Resources
        #Report                                  ${posttraffic_resources}
        Check For Dropped Packets
        Evaluate Post Traffic Measurments
        #Run Malicious Traffic

Report Results
        Set Test Message        *HTML*<p>${PERFORMANCE_RESULTS} </p>
        Set Test Message        Device stability prior to running traffic was: ${DEVICE_STABLE}                         append=True

        ${final_result}=        Set Variable                                            ${PERFORMANCE_RESULTS}
        Set Test Message        Dropped Packets = ${DROPPED_PACKETS}                    append=True
        ${final_result}=        Catenate                                                SEPARATOR=\n            ${final_result}         Dropped Packets = ${DROPPED_PACKETS}
        Set Test Message        <p>Threat Counts = ${THREAT_COUNTS} </p>                append=True
        ${final_result}=        Catenate                                                SEPARATOR=\n            ${final_result}         Threat Counts = ${THREAT_COUNTS}
        Set Test Message        <p>CPU Core Average Loads=<p>${CPU_AVG_LOADS}</p>       append=True
        ${final_result}=        Catenate                                                SEPARATOR=\n            ${final_result}         CPU Core Average Loads=${CPU_AVG_LOADS}
        #Set Test Message       <p>CPU Core Max Loads=<p>${CPU_MAX_LOADS}</p>           append=True
        #${final_result}=       Catenate                                                SEPARATOR=\n            ${final_result}         CPU Core Max Loads=${CPU_MAX_LOADS}
#        Set Test Message        <p>Test TAG=%{TEST_TAG}</p>                             append=True
#        ${final_result}=        Catenate                                                SEPARATOR=\n            ${final_result}         Test TAG=%{TEST_TAG}
        ${failures}=            Get Lines Containing String                             ${final_result}         FAIL                    case_insensitive=True
        Log                     ${PERFORMANCE_RESULTS}

        ${pass}=                Run Keyword and Return Status                           Should Be Empty         ${failures}
        Run Keyword Unless      ${pass}                                                 Set Suite Variable      ${CAUSE_OF_FAILURE}     ${failures}
        Run Keyword Unless      ${pass}                                                 Set Test Message        ${CAUSE_OF_FAILURE}
        Should Contain          ${CAUSE_OF_FAILURE}                                     Unknown                 ${CAUSE_OF_FAILURE}


*** Keywords ***

Report                          [arguments]                             ${message}
        Log                     ${message}
        Set Test Message        ${message}                              append=True

Use Small Ruleset
        ${smallruleset}=                        Catenate                                SEPARATOR=              ${targetRuleset}        -subPA3000
        Set Suite Variable                      ${targetRuleset}                        ${smallruleset}

Watch for Successful Commit
        ${resp}=                Wait For Successful Commit
        Log                     ${resp}
        Should Contain          ${resp}                                 'successful'
        Should Not Contain      ${resp}                                 ERROR

Run PA500 Traffic
        Set Suite Variable      ${MIN_THROUGHPUT}                       ${MIN_THROUGHPUT_PA500}
        Set Suite Variable      ${MAX_LATENCY}                          ${MAX_LATENCY_PA500}
        Set Suite Variable      ${MAX_DROPPED_PACKETS}                  ${MAX_DROPPED_PACKETS_500}
        Set Test Message        Expecting minimum thoughput: ${MIN_THROUGHPUT} and maximum latency: ${MAX_LATENCY}
        ${perf_test}=           Set Variable                            Master-PAN500-http-balanced
        ${results}=             Run Breaking Point Traffic              ${perf_test}
        ${false_string}=        Get Lines Containing String             ${results}                              testResult=failed
        ${BPresults}=           Remove String                           ${results}                              ${false_string}
        ${false_string}=        Get Lines Containing String             ${results}                              testResult=passed
        ${BPresults}=           Remove String                           ${results}                              ${false_string}
        Set Suite Variable      ${BP_Traffic_Results}                   ${BPresults}

Run PA3000 Traffic
        Set Suite Variable      ${MIN_THROUGHPUT}                       ${MIN_THROUGHPUT_PA3000}
        Set Suite Variable      ${MAX_LATENCY}                          ${MAX_LATENCY_PA3000}
        Set Suite Variable      ${MAX_DROPPED_PACKETS}                  ${MAX_DROPPED_PACKETS_3000}
        Set Test Message        Expecting minimum thoughput: ${MIN_THROUGHPUT} and maximum latency: ${MAX_LATENCY}
        ${perf_test}=           Set Variable                            PAN3000_http_balanced
        #${results}=             Run Breaking Point Traffic              ${perf_test}
        ${results}=             Run Breaking Point Traffic              PAN3000_http_balanced
        ${false_string}=        Get Lines Containing String             ${results}                              testResult=failed
        ${BPresults}=           Remove String                           ${results}                              ${false_string}
        ${false_string}=        Get Lines Containing String             ${results}                              testResult=passed
        ${BPresults}=           Remove String                           ${results}                              ${false_string}
        Set Suite Variable      ${BP_Traffic_Results}                   ${BPresults}


Run Benign Performance Traffic
        Clear PAN Sessions
        Clear PAN Stats
        Get Pre-Traffic Packet Counts
        ${stats}=               Get PAN Stats
        Log                     ${stats}

        Run Keyword If          "${PAN_MODEL}"=="PA-500"                Run PA500 Traffic
        Run Keyword If          "${PAN_MODEL}"=="PA-3020"               Run PA3000 Traffic

        Log                     ${BP_Traffic_Results}
        Set Test Message        ${BP_Traffic_Results}                   append=True
        Should Not Contain      ${BP_Traffic_Results}                   ERROR

Check If CPU Has Normalized
        ${datestr}                              ${timestamp}=                           Get PAN Time
        Set Suite Variable                      ${STARTTIME}                            ${timestamp}
        Report                                  PAN device time:${datestr} (${STARTTIME})
        Sleep                   2m                                                      Wait for CPU Utilization to settle below 10pcnt
        Set Suite Variable      ${DEVICE_STABLE}                                        Unstable
        ${result}               ${details}=     Test PAN Resources                      ${STARTTIME}            cpu-load-maximum
        Log                     ${details}
        Should Not Contain      ${details}      FAIL                                    ${details}
        ${result}               ${details}=     Test PAN Resources                      ${STARTTIME}            cpu-load-average
        Log                     ${details}
        Should Not Contain      ${details}      FAIL                                    ${details}
        Set Suite Variable      ${DEVICE_STABLE}                                        Stable
        ${max_sessions}=        Get PAN Max Sessions                                    ${STARTTIME}
        Log                     ${max_sessions}


Evaluate Post Traffic Measurments
        Get Post-Traffic Packet Counts

        #${result}              ${details}=     Test PAN Resources                      ${STARTTIME}            cpu-load-maximum                95.0
        #Set Suite Variable     ${CPU_MAX_LOADS}                                        ${result}
        #Set Suite Variable     ${CPU_MAX_LOADS_DETAILS}                                ${details}
        #Report                 ${details}
        #Log                    ${details}
        #${success}=            Run Keyword and Return Status                           Should Not Contain      ${details}                      FAIL
        #Run Keyword Unless     ${success}                                              Set Suite Variable      ${CAUSE_OF_FAILURE}             ${result}\n${details}

        ${result}               ${details}=     Test PAN Resources                      ${STARTTIME}            cpu-load-average                85.0
        Set Suite Variable      ${CPU_AVG_LOADS}                                        ${result}
        Set Suite Variable      ${CPU_AVG_LOADS_DETAILS}                                ${details}
        Report                  ${details}
        Log                     ${details}
        ${max_sessions}=        Get PAN Max Sessions                                    ${STARTTIME}
        Log                     ${max_sessions}
        Set Suite Variable      ${MAX_SESSION_CNT}                                      ${max_sessions}
        ${success}=             Run Keyword and Return Status                           Should Not Contain      ${details}                      FAIL
        Run Keyword Unless      ${success}                                              Set Suite Variable      ${CAUSE_OF_FAILURE}             ${result}\n${details}
        Verify Results Are Within Acceptable Limits                                     ${BP_Traffic_Results}
        Verify Traffic Passed Thru PAN Device
        ${scwxcnt}              ${pancnt}                                               ${threats}=             Get Threat Data                         ${STARTTIME}
        Log                     scwx alerts: ${scwxcnt}, pan alerts: ${pancnt}
        Log                     ${threats}
        Set Suite Variable      ${THREAT_COUNTS}                                        scwx alerts: ${scwxcnt}, pan alerts: ${pancnt}
        Check For Dropped Packets

Check For Dropped Packets
        ${stats}=               Get Pan Stats
        Set Suite Variable      ${PAN_STATS}                                    ${stats}
        Log                     ${stats}
        ${droppedstr}=          Get Pan Stats                                   DROP
        ${dropped}=             Remove String                                   ${droppedstr}           DROP:
        Set Suite Variable      ${DROPPED_PACKETS}                              ${dropped}
        ${int_dropped}=         Convert To Integer                              ${dropped}
        ${int_max_dropped}=     Convert To Integer                              ${MAX_DROPPED_PACKETS}
        ${acceptable}=          Evaluate                                        $int_dropped<=$int_max_dropped
        Run Keyword Unless      ${acceptable}                                   Set Suite Variable      ${CAUSE_OF_FAILURE}     Too Many dropped packets:${DROPPED_PACKETS}
        ${n_pkts}=              Get Pan Stats                                   N_PACKETS


Run Malicious Traffic
        Log To Console          Running BP profile Master-PCAP-Ruleset-Testing_rule-pcap
        ${results}=             Run Breaking Point Traffic              Master-PCAP-Ruleset-Testing_rule-pcap
        Log                     ${results}
        Set Test Message        ${results}                              append=True
        Should Not Contain      ${results}                              ERROR
        Log To Console          Running BP profile Master-PCAP-Ruleset-testing_tuple
        ${results}=             Run Breaking Point Traffic              Master-PCAP-Ruleset-testing_tuple
        Set Test Message        ${results}                              append=True
        Log                     ${results}
        Should Not Contain      ${results}                              ERROR
        Log To Console          Running BP profile Master-PCAP-Ruleset-testing-http-rerun
        ${results}=             Run Breaking Point Traffic              Master-PCASP-Ruleset-testing-http-rerun
        Log                     ${results}
        Set Test Message        ${results}                              append=True
        Should Not Contain      ${results}                              ERROR
        Log To Console          Running BP profile Master-PCAP-Ruleset-Testing-http_t3
        ${results}=             Run Breaking Point Traffic              Master-PCAP-Ruleset-Testing_t3
        Log                     ${results}
        Set Test Message        ${results}                              append=True
        Should Not Contain      ${results}                              ERROR
        #Verify Traffic Generated

Verify Results Are Within Acceptable Limits                             [Arguments]                     ${results}

        ${avgTx_line}=          Get Lines Containing String             ${results}                      Average Tx Data Rate Mb/s,
        ${avg_Tx_data_rate}=    Replace String                          ${avgTx_line}                   Average Tx Data Rate Mb/s,      ${EMPTY}
        Should Not Be Empty     ${avg_Tx_data_rate}                     Breaking Point returned a null report
        ${AVG_TX_DATA_RATE}=    Convert To Number                       ${avg_Tx_data_rate}
        ${avgRx_line}=          Get Lines Containing String             ${results}                      Average Rx Data Rate Mb/s,
        ${avg_Rx_data_rate}=    Replace String                          ${avgRx_line}                   Average Rx Data Rate Mb/s,      ${EMPTY}
        ${AVG_RX_DATA_RATE}=    Convert To Number                       ${avg_Rx_data_rate}
        ${avg_Lat_line}=        Get Lines Containing String             ${results}                      Average,
        ${avg_Lat_data_rate}=   Replace String                          ${avg_Lat_line}                 Average,                        ${EMPTY}
        ${AVG_LATENCY}=         Convert To Number                       ${avg_Lat_data_rate.lstrip('~')}
        ${min_throughput}=      Convert To Number                       ${MIN_THROUGHPUT}
        ${max_latency}=         Convert To Number                       ${MAX_LATENCY}
        Set Suite Variable      ${PERFORMANCE_RESULTS}                  ${results}\n
        Capture Metrics for Standard Deviation Samples                  ${AVG_TX_DATA_RATE}             ${AVG_LATENCY}
        Run Keyword If          ${AVG_TX_DATA_RATE}<${min_throughput}   Set Suite Variable              ${CAUSE_OF_FAILURE}     Average Tx rate of ${AVG_TX_DATA_RATE} is too low
        Run Keyword If          ${AVG_RX_DATA_RATE}<${min_throughput}   Set Suite Variable              ${CAUSE_OF_FAILURE}     Average Rx rate of ${AVG_RX_DATA_RATE} is too low
        Run Keyword If          ${AVG_LATENCY}>${max_latency}           Set Suite Variable              ${CAUSE_OF_FAILURE}     Average Latency of ${AVG_LATENCY} is too high
        Should Contain          ${CAUSE_OF_FAILURE}                     Unknown                         ${CAUSE_OF_FAILURE}

Release Resource and Report Results
        Release Resources
        Run Keyword If All Critical Tests Passed        Email Test Has Passed
        Run Keyword If Any Critical Tests Failed        Email Test Has Failed


Email Test Has Passed
        Set Mail Subject        Ruleset test has PASSED on ${PAN_MODEL} with ruleset ${targetRuleset}
        Append Config           Pan Model: ${PAN_MODEL}
        Log to Mail             ${RULESET_DIFFS}                                                title=Ruleset Differences between ${FIRST} and ${SECOND}
        Log To Mail             sums matched ${SHA256}                                          title=SHA256 Sum Validity Test
        Log To Mail             ${PERFORMANCE_RESULTS}                                          title=Performance Results
        Log To Mail             ${CPU_AVG_LOADS_DETAILS}                                        title=Average CPU Load Test
        #Log To Mail            ${CPU_MAX_LOADS_DETAILS}                                        title=Maximum CPU Load Test
	Log To Mail		${DROPPED_PACKETS}						title=Dropped Packets
        Log To Mail             ${PAN_STATS}                                                    title=Pan Statistics
        Log To Mail             ${THREAT_COUNTS}                                                title=Threat Count
        Log To Mail             ${MAX_SESSION_CNT}                                              title=Max Sessions
        Log To Mail             Test Report:                                                    reportfile
        Log To Mail             Test Log:                                                       logfile
#        Run Keyword and Ignore Error                    Log To Mail                             %{TEST_TAG}                     title=Tag
        ${resp}=                Mail Report             attach=reportfile,logfile
        Log                     ${resp}

Insert Report Details
        ${defined}=             Run Keyword And Return Status                                   Check Teardown Variables
        Run Keyword Unless      ${defined}                                                      Return From Keyword
        Append Config           PAN Model: ${PAN_MODEL}
        Log to Mail             ${RULESET_DIFFS}                                                title=Ruleset Differences between ${FIRST} and ${SECOND}

Check Teardown Variables
        Variable Should Exist   ${FIRST}
        Variable Should Exist   ${SECOND}
        Variable Should Exist   ${RULESET_DIFFS}
        Variable Should Exist   ${PAN_MODEL}

Email Test Has Failed
        Set Mail Subject        Ruleset test has FAILED on ${PAN_MODEL} ruleset ${targetRuleset}
        Append Config           Pan Model: ${PAN_MODEL}
        Log To Mail             ${CAUSE_OF_FAILURE}                                             title=Cause of Failure
        Insert Report Details
        Append Config           Pan Model: ${PAN_MODEL}
        Log to Mail             ${RULESET_DIFFS}                                                title=Ruleset Differences between ${FIRST} and ${SECOND}
        Log To Mail             sums matched ${SHA256}                                          title=SHA256 Sum Validity Test
        Log To Mail             ${PERFORMANCE_RESULTS}                                          title=Performance Results
        Log To Mail             ${CPU_AVG_LOADS_DETAILS}                                        title=Average CPU Load Test
        #Log To Mail            ${CPU_MAX_LOADS_DETAILS}                                        title=Maximum CPU Load Test
	Log To Mail		${DROPPED_PACKETS}						title=Dropped Packets
        Log To Mail             ${PAN_STATS}                                                    title=Pan Statistics
        Log To Mail             ${THREAT_COUNTS}                                                title=Threat Count
        Log To Mail             ${MAX_SESSION_CNT}                                              title=Max Sessions
        Log To Mail             Test Report:                                                    reportfile
        Log To Mail             Test Log:                                                       logfile
#        Run Keyword and Ignore Error                    Log To Mail                             \n%{TEST_TAG}
        ${resp}=                Mail Report             attach=reportfile,logfile
        Log                     ${resp}

Capture Metrics for Standard Deviation Samples                                  [Arguments]             ${throughput}           ${latency}
        ${timestamp}=           Run                                             date "+%04Y.%02m.%02dT%02H:%02M:%02S"
        ${PAN_MODEL}=           Get_PAN_Info                                    model                   True
        ${PAN_VERSION}=         Get_PAN_Info                                    sw-version              True
        ${content}=             Set Variable                                    ${timestamp},${PAN_MODEL},${PAN_VERSION},${targetRuleset},${throughput},${latency}\n
        Append To File          ${DOCROOT}/pan_performance_samples.csv          ${content}
        Run Keyword And Ignore Error                                            Publish Performance Results


Wrap Up
        ${lasterror}=                           Get Last PAN Error
        Log To Console                          Last error: ${lasterror}
        ${lastwarning}=                         Get Last PAN Warning
        Log To Console                          Last warning: ${lastwarning}
        ${resp}=                                Remove All Locks
        Log                                     ${resp}
        Release Resource and Report Results

Verify No Packets Were Dropped
        Report                                  ${FINAL_TX1}, ${INIT_TX1}, ${FINAL_RX2}, ${INIT_RX2}
        ${dropped_packets}=                     Evaluate                                (${FINAL_TX1}-${INIT_TX1})-(${FINAL_RX2}-${INIT_RX2})
        Should Be Equal As Integers             ${dropped_packets}                      0               ${dropped_packets} were dropped
        Report                                  ${FINAL_TX2}, ${INIT_TX2}, ${FINAL_RX1}, ${INIT_RX1}
        ${dropped_packets}=                     Evaluate                                (${FINAL_TX2}-${INIT_TX2})-(${FINAL_RX1}-${INIT_RX1})
        Should Be Equal As Integers             ${dropped_packets}                      0               ${dropped_packets} were dropped



Get Post-Traffic Packet Counts
        ${txbytes}                              ${rxbytes}=                             Get Packet Counts                       ethernet1/1
        Set Suite Variable                      ${FINAL_TX1}                            ${txbytes}
        Set Suite Variable                      ${FINAL_RX1}                            ${rxbytes}
        Report                                  tx:${txbytes},rx:${rxbytes}
        ${txbytes}                              ${rxbytes}=                             Get Packet Counts                       ethernet1/2
        Set Suite Variable                      ${FINAL_TX2}                            ${txbytes}
        Set Suite Variable                      ${FINAL_RX2}                            ${rxbytes}
        Report                                  tx:${txbytes},rx:${rxbytes}

Verify Traffic Passed Thru PAN Device
        Report                                  ${INIT_TX1}, ${FINAL_TX1}
        Should Not Be Equal As Integers         ${INIT_TX1}                             ${FINAL_TX1}
        Report                                  ${INIT_RX1}, ${FINAL_RX1}
        Should Not Be Equal As Integers         ${INIT_RX1}                             ${FINAL_RX1}
        Report                                  ${INIT_TX2}, ${FINAL_TX2}
        Should Not Be Equal As Integers         ${INIT_TX2}                             ${FINAL_TX2}
        Report                                  ${INIT_RX2}, ${FINAL_RX2}
        Should Not Be Equal As Integers         ${INIT_RX2}                             ${FINAL_RX2}

Get Pre-Traffic Packet Counts
        ${txbytes}                              ${rxbytes}=                             Get Packet Counts                       ethernet1/1
        Set Suite Variable                      ${INIT_TX1}                             ${txbytes}
        Set Suite Variable                      ${INIT_RX1}                             ${rxbytes}
        Log                                     tx:${txbytes},rx:${rxbytes}
        ${txbytes}                              ${rxbytes}=                             Get Packet Counts                       ethernet1/2
        Set Suite Variable                      ${INIT_TX2}                             ${txbytes}
        Set Suite Variable                      ${INIT_RX2}                             ${rxbytes}
        Log                                     tx:${txbytes},rx:${rxbytes}


