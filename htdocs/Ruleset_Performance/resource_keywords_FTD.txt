*** Settings ***
Documentation		Reserves and Releases Resources Needed for Tests


*** Variables ***
${TAF_URL}=     https://localhost:8080/
${IPS_NET}              10.3.0.0/24
${BPS_RSVPORT_V7P1}	'Not Allocated'
${BPS_RSVPORT_V7P2}	'Not Allocated'
${bpGroup}		'Not Allocated'
${TOPOLOGY_NEEDED}      False


*** Settings ***
Library                 OperatingSystem
Library                 SSHLibrary
Library			String
Library                 scwxBPlib2.BreakingPoint	${TestEnvironment}      ${ATF_User}	${VarFile}
Library                 scwxDCIMlib.PathFinder         ${TestEnvironment}      ${ATF_User}
Library                 scwxDCIMlib.LabManager         ${TestEnvironment}      ${ATF_User}
Library                 scwxDCIMlib.Hybrid         ${TestEnvironment}      ${ATF_User}



*** Keywords ***

Set Topology Variable
                        ${is_set}               Run Keyword And Return Status   Environment Variable Should Be Set      bps_Topology 
                        Run Keyword If          ${is_set}                       Set Suite Variable                      ${TOPOLOGY}     %{bps_Topology}
                        ${var_exists}           Run Keyword And Return Status   Variable Should Exist                   \${TOPOLOGY}
			Run Keyword Unless	${var_exists}			Fatal Error				BPS topology is missing

Check Environment
			${is_set}=		Run KeyWord And Return Status	Variable Should Exist			\${ftd_IP}
			Run Keyword Unless	${is_set}			Fatal Error				FTD device address is not defined
			${is_set}=              Run KeyWord And Return Status   Variable Should Exist                   \${fmc_IP}
			Run Keyword Unless      ${is_set}                       Fatal Error                             FMC address is not defined
			Set Topology Variable			
			
Reserve Resources	[Arguments]			${traffic}=None
			${traffic_generator}=		Decode Bytes To String				${traffic}	ASCII	errors=strict
			Run Keyword If			'${traffic_generator}'=='Breaking Point'	Reserve Breaking Point Resources
			Run Keyword If                  '${traffic_generator}'=='ione'                  Reserve Ione Resources
			Log                             topology is ${TOPOLOGY}
			Run Keyword If                  ${TOPOLOGY_NEEDED}                              Reserve DCIM
			#${eth0}=                        Get ATF IP Address
			#Set Suite Variable              ${ATF_Mgt_IP_Address}                           ${eth0}
		

Set Default BP Traffic File				[Arguments]					${traffic_file}
			Set Suite Variable		${DEFAULT_TRAFFIC_FILE}				${traffic_file}
		

Release Resources
			${result}			${error}=			Run keyword And Ignore Error	Release DCIM	
			Close All Connections	

Reserve DCIM
        		Run Keyword If          "${TOPOLOGY}"=="UNASSIGNED"     Pass Execution          		No topology assigned for this test
       			Run Keyword If          "${TOPOLOGY}"=="DirectConnect"  Pass Execution          		Direct connections require no topology
			${is_set}	        Run Keyword And Return Status   Environment Variable Should Be Set	dcim_Name
			Run Keyword If          ${is_set}                       Set Suite Variable                      ${dcim_Name}	%{dcim_Name}
			Run Keyword Unless	${is_set}			Fatal Error				DCIM is not in this configuration	
        		Run Keyword If          "${dcim_Name}"=="LabManager"    Reserve LabManager
        		Run Keyword Unless      "${dcim_Name}"=="LabManager"    Reserve PathFinder

Reserve Breaking Point Resources
                        ${is_set}                       Run Keyword And Return Status   Environment Variable Should Be Set      bps_Topology
                        Run Keyword If                  ${is_set}                       Set Suite Variable                      ${BPtopo}       %{bps_Topology}
                        Run Keyword Unless              ${is_set}                       Set Suite Variable                      ${BPtopo}       UNASSIGNED
                        ${is_assigned}=                 Run Keyword And Return Status   Should Not Contain                      ${BPtopo}       UNASSIGNED
                        Run Keyword Unless              ${is_assigned}                  Set Suite Variable                      ${is_set}       False
                        Run Keyword If                  ${is_assigned}                  Set Suite Variable                      ${TOPOLOGY}     ${BPtopo}
                        Run Keyword Unless              ${is_set}                       Set Topology Variable
                        Set Suite Variable              ${BPS_RSVPORT_V7P1}             ${bps_Firstport}
                        Set Suite Variable              ${BPS_RSVPORT_V7P2}             ${bps_Secondport}
                        ${bpgp}=                        Get Breaking Point Group
                        Run Keyword If                  "${bpgp}"=="UNASSIGNED"         Fatal Error                     Breaking Point topology is undefined
                        Should Not Contain              ${bpgp}                         ERROR
                        Set Suite Variable              ${bpGroup}                      ${bpgp}
                        ${p1}=                          Get Port From Port String       ${bps_Firstport}
                        ${p2}=                          Get Port From Port String       ${bps_Secondport}
                        Log To Console                  Breaking Point Ports ${p1} and ${p2} reserved for group ${bpgp}
                        Set Suite Variable              ${TOPOLOGY_NEEDED}              True


Old Reserve Breaking Point Resources
			Set Suite Variable		${BPS_RSVPORT_V7P1}	    	${bps_Firstport}
			Set Suite Variable		${BPS_RSVPORT_V7P2}	    	${bps_Secondport}
			${bpgp}=			Get Breaking Point Group
			Run Keyword If			"${bpgp}"=="UNASSIGNED"		Fatal Error			Breaking Point topology is undefined
			Should Not Contain		${bpgp}				ERROR
			Set Suite Variable              ${bpGroup}		  	${bpgp}
			${p1}=				Get Port From Port String	${bps_Firstport}
			${p2}=				Get Port From Port String       ${bps_Secondport}
			Set Suite Variable		${TOPOLOGY}			%{TOPOLOGY}
			Log To Console			Breaking Point Ports ${p1} and ${p2} reserved for group ${bpgp}

Reserve Ione Resources
                        ${is_set}=                      Run Keyword And Return Status   Environment Variable Should Be Set      ione_Topology
                        Run Keyword If                  ${is_set}                       Set Suite Variable                      ${IONEtopo}     %{ione_Topology}
                        Run Keyword Unless              ${is_set}                       Set Suite Variable                      ${IONEtopo}     UNASSIGNED
                        ${is_assigned}=                 Run Keyword And Return Status   Should Not Contain                      ${IONEtopo}     UNASSIGNED
                        Run Keyword Unless              ${is_assigned}                  Set Suite Variable                      ${TOPOLOGY}     GeneralTest_ione_${iSensorMgmtIp}
                        Run Keyword If                  ${is_assigned}                  Set Suite Variable                      ${TOPOLOGY}     ${IONEtopo}
                        Set Suite Variable              ${TOPOLOGY_NEEDED}              True


Get Port From Port String	[Arguments]		${portstring}
	@{ports_split}=		Split String		${portstring}	,	
	${port}=		Convert To Integer	${ports_split}[1]
	${rport}=		Evaluate		${port}+1
	[Return]		${rport}

Revert Back And Close Connections
        Back-up And Clear Log File
        Remove Log File
        Close All Connections

Remove Log File
        Write   rm -f ${SET_OUTPUT}
        Sleep   10 seconds


Reserve PathFinder
        ${response}=            Reserve PathFinder Topology     ${TOPOLOGY}             force_connection=yes
	Log			${response}
        Should Not Contain      ${response}                     ERROR
        Sleep                   10 sec

Release PathFinder
        ${response}=            Release PathFinder Topology
        Log To Console          ${response}
        Should Not Contain      ${response}                     ERROR

Release DCIM
        Run Keyword If          '${TOPOLOGY}'=='UNASSIGNED'     Pass Execution          No topology assigned for this test
        Run Keyword If          "${TOPOLOGY}"=="DirectConnect"  Pass Execution          Direct connections require no topology
        Run Keyword If          "${dcim_Name}"=="LabManager"    Release LabManager
        Run Keyword Unless      "${dcim_Name}"=="LabManager"    Release PathFinder

Reserve LabManager
        ${response}=            Reserve LabManager Topology     ${TOPOLOGY}
        Log To Console          ${response}
        Should Not Contain      ${response}                     ERROR
        Sleep                   10 sec

Release LabManager
        ${response}=            Release LabManager Topology
        Log To Console          ${response}
        Should Not Contain      ${response}                     ERROR

	
			

	
