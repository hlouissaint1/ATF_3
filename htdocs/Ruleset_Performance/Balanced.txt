Documentation         # Test Case for Ruleset Performance Balanced Category

*** Settings ***
Resource                ruleset_keywords_RS.txt
#Resource		resource_keywords.txt
Resource		iSensorConfiguration.txt	
Resource		VerifyTraffic_RS.txt
Library			SSHLibrary
Library                 OperatingSystem
Library                 BuiltIn
Library                 String
Library                 Collections
Library			scwxCorelib.Mail	${TestEnvironment}		${ATF_User}
Library			ctpapi2.PCSMS		${TestEnvironment}		${ATF_User}
Library			ctpapi2.VulnDB		${TestEnvironment}		${ATF_User}
Suite Setup		Reserve Resources	None	
Suite Teardown		Release Resource and Report Results	

*** Variables ***
${category}			balanced	
${POLICY}			1
${FALSE_POSITIVE_RESULT}        ${category} test failed before the False Positive script could run
${CHECK_SCRIPT_RESULT}          ${category} test failed before the Check.sh script could run

${FP_FILTER}		gawk ' BEGIN{fpm=0} $2~/VID/{ if (($4+0)>=2)fpm=1; if (($4+0)>=0) print $0, (($4+0)>=2)?"<1>":"<0>"; } END {print "FalsePositive=",(fpm==0)?"passed":"failed"} '


*** Test Case ***

Notify Start Of Test via Email
	Set Mail Subject	Starting ruleset test on ${category}.${targetRuleset}
	${iSensor_Model}=	Execute Command						cat /HWTYPE |pcregrep -o 'R\\d{3}' 
	Append Config		iSensor Model: Dell ${iSensor_Model},UIN: ${UIN},IDN: ${IDN}
	Set Suite Variable	${ISENSOR_MODEL}					${iSensor_Model}
	${resp}=		Mail Report
	Log			${resp}
	Set Test Message	${resp}


Verify Current State of Target iSensor
	Log			Test is running in ${TestEnvironment}
	Open SSH Connection
	Validate and Log iSensor Configuration
	Run Keyword and Ignore Error							Disable Watch List Cron Job

Import Ruleset
	Import and Verify Target Ruleset

Download VulnDb Ruleset Diffs To iSensor
	Push Ruleset Diffs To iSensor

Change iSensor's Ruleset Category To Balanced
	Change Ruleset Category
	Sleep					5m

Push Ruleset To iSensor
	Push Ruleset

Verify iSensor Is On New Version
	Verify iSensor Version
	Validate and Log iSensor Configuration

Perform Tests With Group Customizations Enabled
	Enable Ruleset Group Customizations

Mark IPS Uptime For IPS_Up_Test
	Mark Initial IPS Uptime

Run Check Script Test On iSensor
	Run Check Script Test

Verify a SOC Test Alert Is Detected
	${alerted}=					Run Keyword And Return Status		Verify a SOC Test Alert Is Detected
	Run Keyword Unless				${alerted}				Fatal Error				SOC Test alert failed to trigger

Get iSensor swInfo
	Read iSensor swInfo
	
Test iSensor Uptime and sw-info
	Verify iSensor Uptime and sw-info

# The below keyword is used solely to fail the test to prevent baselining while troubleshooting rulesets issues. 
#Force Failure so No Baseline
#        Fatal Error                                                     Himmler Says Force Failure so No Baseline

	
*** Keywords ***

Release Resource and Report Results
	Run Keyword and Ignore Error								Enable Watch List Cron Job
        Delete Diff File
	Release Resources
	Run Keyword If All Critical Tests Passed	Email Test Has Passed
	Run Keyword If Any Critical Tests Failed	Email Test Has Failed
	

Email Test Has Passed
	Set Mail Subject	Ruleset test on ${category}.${targetRuleset} has PASSED		catenate=True
	Append Config		iSensor Model: Dell ${ISENSOR_MODEL},UIN: ${UIN},IDN: ${IDN}
	Log to Mail             ${RULESET_DIFFS}                                                title=Ruleset Differences between ${FIRST} and ${SECOND}
        Log to Mail             ${CHECK_SCRIPT_RESULT}						title=Check.sh test result
        ${count}                ${incidents}=           Get Incidents
        Run Keyword If          ${count}==0             Log To Mail                             There were no incidents         title=Incidents during the test:
        Run Keyword Unless      ${count}==0             Log To Mail                             ${incidents}                    title=Incidents during the test:
	Log To Mail		Test Report:		reportfile	
	Log To Mail		Test Log:		logfile	
	${resp}=		Mail Report		attach=reportfile,logfile
	Log			${resp} 

Insert Report Details
	${defined}=             Run Keyword And Return Status                                   Check Teardown Variables
	Run Keyword Unless      ${defined}                                                      Return From Keyword
	Append Config           iSensor Model: Dell ${ISENSOR_MODEL},UIN: ${UIN},IDN: ${IDN}
	Log to Mail             ${RULESET_DIFFS}                                                title=Ruleset Differences between ${FIRST} and ${SECOND}
	Log to Mail             ${CHECK_SCRIPT_RESULT}                                          title=Check.sh test result

	
Email Test Has Failed
	Set Mail Subject	Ruleset test on ${category}.${targetRuleset} has FAILED		catenate=True
	Insert Report Details
        ${count}                ${incidents}=           Get Incidents
        Run Keyword If          ${count}==0             Log To Mail                             There were no incidents         title=Incidents during the test:
        Run Keyword Unless      ${count}==0             Log To Mail                             ${incidents}                    title=Incidents during the test:
	Log To Mail		Test Report:		reportfile	
	Log To Mail		Test Log:		logfile
	${resp}=		Mail Report		attach=reportfile,logfile
	Log			${resp}

