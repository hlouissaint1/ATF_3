Documentation         # Test Case for Ruleset Performance ASA5545 

*** Settings ***
Library                 OperatingSystem
Library                 BuiltIn
Library			DateTime
Library                 String
Library                 scwxCorelib.Mail		${TestEnvironment}      ${ATF_User}     # ${VarFile}
Library			scwxASAlib.FMC			${TestEnvironment}	${ATF_User}	#${VarFile}
Library                 scwxASAlib.Ignite               ${TestEnvironment}      ${ATF_User}
Library			scwxBPlib2.BreakingPoint	${TestEnvironment}	${ATF_User}	#${VarFile}
Resource		resource_keywords_FTD.txt
Resource                aws_ec2_instance.txt
#Suite Setup		Reserve Resources		Breaking Point	
Suite Setup             Setup ASA Environment
Suite Teardown       	Wrap Up

*** Setting ***
Variables		scwxASAlib.py		

*** Variables ***
${MIN_THROUGHPUT_1G}            550.000
${MAX_LATENCY_1G}               550.00
${MAX_DROPPED_PACKETS_1G}      	0 
${DOCROOT}                      /var/www/html/htdocs
${NO_DATA}			Value is not available due to error occuring in previous step
${PERFORMANCE_RESULTS}		${NO_DATA}
${DROPPED_PACKETS}		${NO_DATA}
${CPU_AVG_LOADS}		${NO_DATA}
${CPU_MAX_LOADS}		${NO_DATA}
${ASA_STATS}			${NO_DATA}
${CPU_MAX_LOADS_DETAILS}	${NO_DATA}
${POST_TRAFFIC_CPU_USAGE}	${NO_DATA}
${INIT_TX1}			0
${INIT_RX1}			0
${INIT_TX2}			0
${INIT_RX2}			0
${DEVICE_STABLE}		Unknown
${MAX_DROPPED_PACKETS}		${NO_DATA}
${CAUSE_OF_FAILURE}		No Problem Found	
${RULESET_DIFFS}		${EMPTY}
${BENIGN_TRAFFIC_1G}            ASA_dswrx_appmix_1g
${ASA_MODEL}			Unknown
${FIRST}			Unknown
${SECOND}			Unknown
${Model_ASA5545}		ASA5545
${HISTORY_FILE}                 ${DOCROOT}/history/vrt_ruleset/firepower_performance_samples.csv

*** Test Case ***

Setup Ignite Test Device
        Start Ignite EC2 Instance               %{ignite_IP}

Setup FMC Test Device
        Start FMC EC2 Instance                  %{fmc_IP}


Get Current FMC Device Information		[Documentation]				FMC info
	${info}=				Get System Info				
	Report					FMC:${info}
	${model}= 			        Get ASA Model
	Set Suite Variable			${ASA_MODEL}				${model}
	${device_info}=				Get ASA Info
	@{OSVersion}=                           Get Regexp Matches                      ${device_info}                          (Version)(.*\\))         2
        Log                                     ${OSVersion}
        Set Suite Variable                      ${OSV}                                  ${OSVersion}[0]
	
	Set Suite Variable			${BASE_RULESET}				${targetRuleset}
	Report                                  ASA Information: ${device_info}
	Log					Model: "${ASA_MODEL}" under test
	Log					${VarFile}

Get Device Info
	${health}=				Get Device Records			return_health=True
	Set Suite Variable			${DEVICE_HEALTH}			${health}

Get Current Ruleset Version On ASA Device	[Documentation]				Identifies the ruleset version
	${version}=				Get ASA CTU Ruleset Version
	Report					Version: ${version} will be replaced with:${targetRuleset}
	Set Suite Variable			${FIRST}				${version}
	Set Suite Variable			${SECOND}				${targetRuleset}

Get Ruleset RC From VulnDB
	${ruleset_file}=			Download CTU Ruleset			${targetRuleset} 
	Fail Test If Unsuccessful		${ruleset_file}				Unable to retrieve CTU release candidate ruleset:${ruleset_file}
	Report					version ${targetRuleset} successfully downloaded from VulnDB
	Set Suite Variable			${RS_FILE}		${ruleset_file}
	Report					Ruleset File = ${RS_FILE}
	${released}=				Get_Released_CTU_Ruleset_Version	${targetRuleset}
	${diffs}=				Download CTU Ruleset Diffs		${released}		${targetRuleset}
	Set Suite Variable			${RULESET_DIFFS}			${diffs}	
	Run Keyword and Ignore Error		Should Not Contain			${diffs}				ERROR	
	Report					${diffs} 

#Copy Rulesets to FMC
#	${destination}				${resp}=				Upload_File_To_FMC	${RS_FILE}
#	${success}=				Run Keyword and Return Status		Should Not Contain	${resp}		ERROR
#	Run Keyword Unless			${success}				Set Suite Variable	${CAUSE_OF_FAILURE}	Failed to upload ruleset to FMC
#	Run Keyword Unless			${success}				Fatal Error		${CAUSE_OF_FAILURE}
#	Run Keyword If				${success}				Report			Candidate ruleset successfully uploaded to FMC
#	Run Keyword If				${success}				Set Suite Variable	${RS_FILE}		${destination}
	

Install Release Candidate on FMC
	${version_on_ftd}=			Get ASA CTU Ruleset Version			
	Run Keyword If				"${version_on_ftd}"=="${targetRuleset}"		Report		Ruleset is already on version ${version_on_ftd}
	Run Keyword If                          "${version_on_ftd}"=="${targetRuleset}" 	Pass Execution	Ruleset is already on version ${version_on_ftd}	

	${resp}=				Import_CTU_Ruleset_On_Ignite			${RS_FILE}	ari-balanced		ATFlab_ASA5545_Performance_with_CTU_bal	
	Log					${resp}
	${success}=                             Run Keyword and Return Status           Should Not Contain      ${resp}                 ERROR
	Run Keyword Unless                      ${success}                              Set Suite Variable      ${CAUSE_OF_FAILURE}     ${resp}
	Run Keyword Unless                      ${success}                              Fatal Error             ${CAUSE_OF_FAILURE}
	Report                                  Successfully Imported CTU ruleset onto Ignite



Deploy Ruleset To Device
	${version_on_ftd}=                      Get ASA CTU Ruleset Version
	Run Keyword If                          "${version_on_ftd}"=="${targetRuleset}"         Report          Ruleset is already on version ${version_on_ftd}
	Run Keyword If                          "${version_on_ftd}"=="${targetRuleset}"         Pass Execution  Ruleset is already on version ${version_on_ftd}
	${resp}=				Deploy_Policy_To_ASA_Device			
	${success}=                             Run Keyword and Return Status           	Should Not Contain      ${resp}         	ERROR
	Run Keyword Unless                      ${success}                              	Set Suite Variable      ${CAUSE_OF_FAILURE}     ${resp}
	Run Keyword Unless                      ${success}                              	Fatal Error             ${CAUSE_OF_FAILURE}
	Fail Test If Unsuccessful		${resp}						Error while installing CTU ruleset onto FMC: ${resp}
	Wait Until Keyword Succeeds           	10m                                             1m              Wait For Ruleset to Deploy to Device
	Report 			                						Successfully Deployed CTU ruleset to ASA Device

	

Verify ASA Device Is On New Version
        ${result}=                              Verify ASA CTU Ruleset Version		${targetRuleset}
	${verified}=                            Run Keyword and Return Status           Should Contain			${result}		PASSED
	Run Keyword Unless                      ${verified}                             Set Suite Variable      	${CAUSE_OF_FAILURE}	candidate ruleset did not deploy
	Run Keyword Unless                      ${verified}                             Fatal Error			${CAUSE_OF_FAILURE}
	Run Keyword If                          ${verified}                             Report				Candidate ruleset ${targetRuleset} successfully deployed

Get Ruleset Differences
	${diffs}=				Download CTU Ruleset Diffs		${FIRST}			${SECOND}
	Report					${diffs}
	#${result}=				Verify ASA Ruleset Diffs		${FIRST}			${SECOND}
	#${success}=                             Run Keyword and Return Status           Should Not Contain      	${result} 	        ERROR
	#Run Keyword Unless                      ${success}                              Set Suite Variable      	${CAUSE_OF_FAILURE}     ${result}
	#Run Keyword Unless                      ${success}                              Fatal Error             	${CAUSE_OF_FAILURE}
	#Run Keyword If                          ${success}                              Report                  	${result}
	


Run Traffic Thru the FirePOWER Device and Verify Performance
        ${resp}=                                Restart Snort
        Log                                     ${resp}
	#Get Pre-Traffic Packet Counts
	${memory_usage}=			Get ASA Memory Usage
	Set Suite Variable                      ${PRE_TRAFFIC_MEMORY_USAGE}		${memory_usage}
	Report					${PRE_TRAFFIC_MEMORY_USAGE}
	Fail Test If Unsuccessful		${memory_usage}				${memory_usage}
	Wait Until Keyword Succeeds		30m					3m			Monitor ASA Until Stabilized From Previous Test	
	${datestr}				${timestamp}=				Get ASA Time		
	${datestr}				${timestamp}=				Get ASA Time
	Set Suite Variable			${STARTTIME}				${timestamp}
	Report					ASA device time:${datestr} (${STARTTIME})

	Run Benign Performance Traffic


	${memory_usage}=			Get ASA Memory Usage
	Set Suite Variable                      ${POST_TRAFFIC_MEMORY_USAGE}		${memory_usage}
	Report					${POST_TRAFFIC_MEMORY_USAGE}
	Fail Test If Unsuccessful               ${memory_usage}                         ${memory_usage}

	${datestr}				${timestamp}				Get ASA Time
	${cpu_utilization}=			Get ASA CPU Stats			${STARTTIME}		${timestamp}		35.0		40.0
	Set Suite Variable			${POST_TRAFFIC_CPU_USAGE}		${cpu_utilization}
	
	Report					${POST_TRAFFIC_CPU_USAGE}
	Fail Test If Unsuccessful               ${cpu_utilization}                      ${cpu_utilization}

	${datestr}				${timestamp}				${elapsed}=		Get ASA Time		return_elapsed=${STARTTIME}
	Set Suite Variable			${ENDTIME}				${timestamp}
	Report					ASA device time:${datestr} (${ENDTIME}) Elapsed=${elapsed} seconds
		
	Evaluate Post Traffic Measurments
	#Run Malicious Traffic

Report Results
	Set Test Message	*HTML*<p>${PERFORMANCE_RESULTS} </p>
	Set Test Message	Device health prior to running traffic was: ${DEVICE_HEALTH}			append=True 
	
	${final_result}=	Set Variable						${PERFORMANCE_RESULTS}
	Set Test Message	Firewall Packet Data: ${DROPPED_PACKETS}		append=True
	${final_result}=	Catenate						SEPARATOR=\n		${final_result}		Firewall Packet Data: ${DROPPED_PACKETS} 

	Set Test Message	<p>CPU Core Utilization=<p>${POST_TRAFFIC_CPU_USAGE}</p>			append=True
	${final_result}=	Catenate						SEPARATOR=\n		${final_result}		CPU Loads=${POST_TRAFFIC_CPU_USAGE}
	${failures}=		Get Lines Containing String				${final_result}		FAIL			case_insensitive=True
	Log			${PERFORMANCE_RESULTS}			

	${pass}=		Run Keyword and Return Status				Should Be Empty		${failures}
	Run Keyword Unless	${pass}							Set Suite Variable      ${CAUSE_OF_FAILURE}	${failures}
	Run Keyword Unless      ${pass}							Set Test Message	${CAUSE_OF_FAILURE}
	Should Contain		${CAUSE_OF_FAILURE}					No Problem Found	${CAUSE_OF_FAILURE}
	
# The below keyword is used solely to fail the test to prevent baselining while troubleshooting rulesets issues.
#Force Failure so No Baseline
#        Fatal Error                                                     Himmler Says Force Failure so No Baseline

*** Keywords ***

Setup ASA Environment
	Reserve Resources                       Breaking Point


Stop The ASA EC2 Instance
        Stop FMC EC2 Instance                   %{fmc_IP}


Wait For Ruleset to Deploy to Device
        ${version_on_ftd}=                      Get ASA CTU Ruleset Version
        Should Be Equal As Strings              "${version_on_ftd}"                     "${targetRuleset}"      Target ruleset deployed


Fail Test If Unsuccessful	[arguments]				${result}		${on_error}		
        ${success}=             Run Keyword and Return Status           Should Not Contain      ${result}	        ERROR
	Run Keyword Unless      ${success}                              Set Suite Variable      ${CAUSE_OF_FAILURE}	${on_error}
        Run Keyword Unless      ${success}                              Fatal Error             ${CAUSE_OF_FAILURE}
        ${success}=             Run Keyword and Return Status           Should Not Contain      ${result}	        FAIL
	Run Keyword Unless      ${success}                              Set Suite Variable      ${CAUSE_OF_FAILURE}	${on_error}
        Run Keyword Unless      ${success}                              Fatal Error             ${CAUSE_OF_FAILURE}

Report				[arguments]				${message}
	Log			${message}
	Set Test Message	${message}				append=True

Monitor ASA Until Stabilized From Previous Test
	${datestr}				${timestamp}=				Get ASA Time		
        ${cpu_utilization}=                     Get ASA CPU Stats                       ${timestamp}            None    30.0            4.0     include_idle_periods=True
	Log					${cpu_utilization}
	Should Not Contain			${cpu_utilization}			FAILED
	Should Not Contain			${cpu_utilization}			ERROR
        Set Suite Variable                      ${PRE_TRAFFIC_CPU_UTILIZATION}          ${cpu_utilization}
        Report                                  ${PRE_TRAFFIC_CPU_UTILIZATION}


	
Run 1G Traffic
        Set Suite Variable      ${MIN_THROUGHPUT}                       ${MIN_THROUGHPUT_1G}
        Set Suite Variable      ${MAX_LATENCY}                          ${MAX_LATENCY_1G}
        Set Suite Variable      ${MAX_DROPPED_PACKETS}                  ${MAX_DROPPED_PACKETS_1G}
        Set Test Message        Expecting minimum thoughput: ${MIN_THROUGHPUT} and maximum latency: ${MAX_LATENCY}
        ${perf_test}=           Set Variable                            ${BENIGN_TRAFFIC_1G}
        ${results}=             Run Breaking Point Traffic              ${perf_test}
        ${false_string}=        Get Lines Containing String             ${results}                              testResult=failed
        ${BPresults}=           Remove String                           ${results}                              ${false_string}
        ${false_string}=        Get Lines Containing String             ${results}                              testResult=passed
        ${BPresults}=           Remove String                           ${results}                              ${false_string}
        Set Suite Variable      ${BP_Traffic_Results}                   ${BPresults}


Set ASA Policy					[Arguments]				${policy}
	#${resp}=				Remove_Existing_Rulesets
	#${success}=                             Run Keyword and Return Status           Should Not Contain      ${resp}                 ERROR
	#Run Keyword Unless                      ${success}                              Set Suite Variable      ${CAUSE_OF_FAILURE}     ${resp}
	#Run Keyword Unless                      ${success}                              Fatal Error             ${CAUSE_OF_FAILURE}
	
	${resp}=				Set Policy Assignment			${policy}
	${success}=                             Run Keyword and Return Status           Should Not Contain      ${resp} 		ERROR
	Run Keyword Unless                      ${success}                              Set Suite Variable      ${CAUSE_OF_FAILURE}     ${resp}
	Run Keyword Unless                      ${success}                              Fatal Error             ${CAUSE_OF_FAILURE}
	${ftd_policy}=				Get Policy Assignments
	Run Keyword Unless			"${ftd_policy}"=="${policy}"		Set Suite Variable	${CAUSE_OF_FAILURE}	Failed To Change Policy Assignment
	Run Keyword Unless			"${ftd_policy}"=="${policy}"		Fatal Error		${CAUSE_OF_FAILURE}
	${resp}=				Deploy Policy To ASA			
	${success}=                             Run Keyword and Return Status           Should Not Contain      ${resp}         	ERROR
	Run Keyword Unless                      ${success}                              Set Suite Variable      ${CAUSE_OF_FAILURE}     ${resp}
	Run Keyword Unless                      ${success}                              Fatal Error             ${CAUSE_OF_FAILURE}


Run Benign Performance Traffic

	Run Keyword If          "${ASA_MODEL}"=="${Model_ASA5545}"      Run 1G Traffic
	Run Keyword Unless      "${ASA_MODEL}"=="${Model_ASA5545}"      Fatal Error	This test is designed to run on the ${Model_ASA5545} only

	Log 			${BP_Traffic_Results}
	Set Test Message        ${BP_Traffic_Results}                   append=True
	Should Not Contain	${BP_Traffic_Results}			ERROR

Evaluate Post Traffic Measurments
	#Get Post-Traffic Packet Counts
	#Verify Traffic Passed Thru ASA Device
	${result}=					Verify No Packets Were Dropped
	${success}=                             	Run Keyword and Return Status           Should Not Contain      ${result}	FAILED
	Run Keyword Unless                      	${success}                              Set Suite Variable      ${CAUSE_OF_FAILURE}    		${result}	
	Run Keyword Unless				${success}				Fatal Error		${CAUSE_OF_FAILURE}
	Verify Results Are Within Acceptable Limits	${BP_Traffic_Results}

Run Malicious Traffic
	Log To Console		Running BP profile Master-PCAP-Ruleset-Testing_rule-pcap
	${results}=		Run Breaking Point Traffic		Master-PCAP-Ruleset-Testing_rule-pcap
	Log 			${results}
	Set Test Message        ${results}                              append=True
	Should Not Contain	${results}				ERROR
	Log To Console		Running BP profile Master-PCAP-Ruleset-testing_tuple
	${results}=		Run Breaking Point Traffic		Master-PCAP-Ruleset-testing_tuple
	Set Test Message        ${results}                              append=True
	Log 			${results}
	Should Not Contain	${results}				ERROR
	Log To Console		Running BP profile Master-PCAP-Ruleset-testing-http-rerun
	${results}=		Run Breaking Point Traffic		Master-PCASP-Ruleset-testing-http-rerun
	Log 			${results}
	Set Test Message        ${results}                              append=True
	Should Not Contain	${results}				ERROR
	Log To Console		Running BP profile Master-PCAP-Ruleset-Testing-http_t3
	${results}=		Run Breaking Point Traffic		Master-PCAP-Ruleset-Testing_t3
	Log 			${results}
	Set Test Message        ${results}                              append=True
	Should Not Contain	${results}				ERROR


Define Baseline Metrics							[Arguments]			${results}
	
	${avgTx_line}=		Get Lines Containing String		${results}			Average Tx Data Rate Mb/s,
	${avg_Tx_data_rate}=	Replace String				${avgTx_line}			Average Tx Data Rate Mb/s,	${EMPTY}
	Should Not Be Empty	${avg_Tx_data_rate}			Breaking Point returned a null report
	${AVG_TX_DATA_RATE}=	Convert To Number			${avg_Tx_data_rate}
	${avgRx_line}=		Get Lines Containing String		${results}			Average Rx Data Rate Mb/s,
	${avg_Rx_data_rate}=	Replace String				${avgRx_line}			Average Rx Data Rate Mb/s,	${EMPTY}
	${AVG_RX_DATA_RATE}=	Convert To Number			${avg_Rx_data_rate}
	${avg_Lat_line}=	Get Lines Containing String		${results}			Average,
	${avg_Lat_data_rate}=	Replace String				${avg_Lat_line}			Average,			${EMPTY}
	${AVG_LATENCY}=		Convert To Number			${avg_Lat_data_rate.lstrip('~')}
	${min_tp}=		Convert To Number			${MIN_THROUGHPUT}
	${max_lat}=		Convert To Number			${MAX_LATENCY}
	Set Suite Variable	${BASE_AVG_TX_DATA_RATE}		${AVG_TX_DATA_RATE}
	Set Suite Variable	${BASE_AVG_RX_DATA_RATE}		${AVG_RX_DATA_RATE}
	Set Suite Variable	${BASE_AVG_LATENCY}			${AVG_LATENCY}
	Set Suite Variable      ${BASE_RESULTS}	        	        ${results}\n
	${bl_tx}=		Convert To Integer			${BASE_AVG_TX_DATA_RATE}
	${bl_rx}=		Convert To Integer			${BASE_AVG_RX_DATA_RATE}
	${bl_lat}=		Convert To Integer			${BASE_AVG_LATENCY}
	Run Keyword If          $bl_tx < $min_tp			Set Suite Variable		${CAUSE_OF_FAILURE}	Baseline avg. Tx rate of ${AVG_TX_DATA_RATE} is too low
	Run Keyword If		$bl_rx < $min_tp			Set Suite Variable		${CAUSE_OF_FAILURE}	Baseline avg. Rx rate of ${AVG_RX_DATA_RATE} is too low
	Run Keyword If		$bl_lat > $max_lat			Set Suite Variable		${CAUSE_OF_FAILURE}	Baseline avg. latency is to high
	Should Contain          ${CAUSE_OF_FAILURE}                     No Problem Found                ${CAUSE_OF_FAILURE}
	

Verify Results Are Within Acceptable Limits				[Arguments]			${results}
		
	${avgTx_line}=		Get Lines Containing String		${results}			Average Tx Data Rate Mb/s,
	${avg_Tx_data_rate}=	Replace String				${avgTx_line}			Average Tx Data Rate Mb/s,	${EMPTY}
	Should Not Be Empty	${avg_Tx_data_rate}			Breaking Point returned a null report
	${AVG_TX_DATA_RATE}=	Convert To Number			${avg_Tx_data_rate}
	${avgRx_line}=		Get Lines Containing String		${results}			Average Rx Data Rate Mb/s,
	${avg_Rx_data_rate}=	Replace String				${avgRx_line}			Average Rx Data Rate Mb/s,	${EMPTY}
	${AVG_RX_DATA_RATE}=	Convert To Number			${avg_Rx_data_rate}
	${avg_Lat_line}=	Get Lines Containing String		${results}			Average,
	${avg_Lat_data_rate}=	Replace String				${avg_Lat_line}			Average,			${EMPTY}
	${AVG_LATENCY}=		Convert To Number			${avg_Lat_data_rate.lstrip('~')}

	${min_throughput}=	Convert To Number			${MIN_THROUGHPUT}

	${max_latency}=		Convert To Number			${MAX_LATENCY}

	Set Suite Variable	${PERFORMANCE_RESULTS}			${results}\n
	Run Keyword If		$AVG_TX_DATA_RATE < $min_throughput	Set Suite Variable		${CAUSE_OF_FAILURE}	Average Tx rate of ${AVG_TX_DATA_RATE} is too low
	Run Keyword If		$AVG_RX_DATA_RATE < $min_throughput	Set Suite Variable		${CAUSE_OF_FAILURE}	Average Rx rate of ${AVG_RX_DATA_RATE} is too low
	Run Keyword If		$AVG_LATENCY > $max_latency		Set Suite Variable		${CAUSE_OF_FAILURE}	Average Latency of ${AVG_LATENCY} is too high
	${failed}=              Run Keyword and Return Status           Should Not Contain              ${CAUSE_OF_FAILURE}     No Problem Found
	Capture Metrics for Standard Deviation Samples			${AVG_TX_DATA_RATE}		${AVG_LATENCY}		${failed}
	

Release Resource and Report Results
        Release Resources
        Run Keyword If All Critical Tests Passed        		Email Test Has Passed
        Run Keyword If Any Critical Tests Failed        		Email Test Has Failed


Email Test Has Passed
        Set Mail Subject        Ruleset test has PASSED on ${ASA_MODEL} with ruleset ${targetRuleset}
	${ASA_INFO}		Get_ASA_Model
        Append Config           ASA Model: ${ASA_INFO}
        Log to Mail             ${RULESET_DIFFS}	                                        title=Ruleset Differences between ${FIRST} and ${SECOND}
	Log To Mail		${PERFORMANCE_RESULTS}						title=Performance Results
	Log To Mail		${POST_TRAFFIC_CPU_USAGE}					title=CPU Load During Traffic	
	Log To Mail		${ASA_STATS}							title=${ASA_MODEL} Interface Statistics
	Log To Mail		${DROPPED_PACKETS}						title=Packets Dropped by Firewall
        Log To Mail             Test Report:							reportfile
        Log To Mail             Test Log:							logfile
	Log To Mail		${HISTORY}							title=Performance History Link
	${resp}=                Mail Report             					attach=reportfile,logfile
        Log                     ${resp}

Insert Report Details
	${defined}=             Run Keyword And Return Status                                   Check Teardown Variables
	Run Keyword Unless      ${defined}                                                      Return From Keyword
        Log to Mail             ${RULESET_DIFFS}                                                title=Ruleset Differences between ${FIRST} and ${SECOND}

Check Teardown Variables
	Variable Should Exist   ${FIRST}
	Variable Should Exist   ${SECOND}
	Variable Should Exist   ${RULESET_DIFFS}
	Variable Should Exist   ${ASA_MODEL}

Email Test Has Failed
        Set Mail Subject        Ruleset test has FAILED on ${ASA_MODEL} ruleset ${targetRuleset}
	${ASA_INFO}		Get_ASA_Model
        Append Config           ASA Model: ${ASA_INFO}
	Log To Mail		${CAUSE_OF_FAILURE}						title=Cause of Failure
	Insert Report Details
        Log to Mail             ${RULESET_DIFFS}	                                        title=Ruleset Differences between ${FIRST} and ${SECOND}
	Log To Mail		${PERFORMANCE_RESULTS}						title=Performance Results
	Log To Mail		${POST_TRAFFIC_CPU_USAGE}					title=CPU Load During Traffic	
	Log To Mail		${ASA_STATS}							title=${ASA_MODEL} Interface Statistics
        Log To Mail             Test Report:							reportfile
        Log To Mail             Test Log:							logfile
	${resp}=                Mail Report             					attach=reportfile,logfile
        Log                     ${resp}
	
Capture Metrics for Standard Deviation Samples					[Arguments]		${throughput}		${latency}	${failed}	
	${timestamp}=		Run						date "+%04Y.%02m.%02dT%02H:%02M:%02S"
	${ASA_SRU_VERSION}=	Get SRU Version	
        Run Keyword If          ${failed}                                       Set Test Variable       ${result}               FAILED
        Run Keyword Unless      ${failed}                                       Set Test Variable       ${result}               PASSED
	${content}=		Set Variable					${timestamp},${ASA_MODEL},${ASA_SRU_VERSION},${targetRuleset},${throughput},${latency},${OSV},${result}\n
        Append To File          ${HISTORY_FILE}                                 ${content}
	#${perf_history}=	Publish Performance Results
        ${perf_history}=	Set Variable					"Not Availble"
	Set Suite Variable	${HISTORY}					${perf_history}
	LOG			${perf_history}
	

Wrap Up
	Release Resource and Report Results

Verify No Packets Were Dropped
	${result}=				Get Packet Metrics			${STARTTIME}		${END_TIME}
	Set Suite Variable			${DROPPED_PACKETS}			${result}
	Report					${result}
	${passed}=				Run Keyword and Return Status		Should Not Contain	${result}		FAILED
	Run Keyword Unless			${passed}				Set Suite Variable	${CAUSE_OF_FAILURE}	${result}
	[Return]				${result}
	



Get Post-Traffic Packet Counts
	Sleep					120s
	${txbytes}=				Get Interface Stats			in					return_pkts_out=True
	Should Not Contain			${txbytes}				ERROR
	${rxbytes}=				Get Interface Stats			in					return_pkts_in=True
	Should Not Contain			${rxbytes}				ERROR
	Set Suite Variable			${FINAL_TX1}				${txbytes}
	Set Suite Variable			${FINAL_RX1}				${rxbytes}
	Report					tx:${txbytes},rx:${rxbytes}
	${txbytes}=				Get Interface Stats			out					return_pkts_out=True
	Should Not Contain			${txbytes}				ERROR
	${rxbytes}=				Get Interface Stats			out					return_pkts_in=True
	Should Not Contain			${rxbytes}				ERROR
	Set Suite Variable			${FINAL_TX2}				${txbytes}
	Set Suite Variable			${FINAL_RX2}				${rxbytes}
	Set Suite Variable			${ASA_STATS}				tx:${txbytes},rx:${rxbytes}
	Report					\\ntx:${txbytes},rx:${rxbytes}

Verify Traffic Passed Thru ASA Device
	Report					${INIT_TX1}, ${FINAL_TX1}
	Should Not Be Equal As Integers		${INIT_TX1}				${FINAL_TX1}
	Report					${INIT_RX1}, ${FINAL_RX1}
	Should Not Be Equal As Integers		${INIT_RX1}				${FINAL_RX1}
	Report					${INIT_TX2}, ${FINAL_TX2}
	Should Not Be Equal As Integers		${INIT_TX2}				${FINAL_TX2}
	Report					${INIT_RX2}, ${FINAL_RX2}
	Should Not Be Equal As Integers		${INIT_RX2}				${FINAL_RX2}

Get Pre-Traffic Packet Counts
	#Return From Keyword	
	${txbytes}=				Get Interface Stats			in					return_pkts_out=True
	Should Not Contain			${txbytes}				ERROR
	${rxbytes}=				Get Interface Stats			in					return_pkts_in=True
	Should Not Contain			${rxbytes}				ERROR
	Set Suite Variable			${INIT_TX1}				${txbytes}
	Set Suite Variable			${INIT_RX1}				${rxbytes}
	Report					tx:${txbytes},rx:${rxbytes}
	${txbytes}=				Get Interface Stats			out					return_pkts_out=True
	${txbytes}=				Get Interface Stats			in					return_pkts_out=True
	${rxbytes}=				Get Interface Stats			out					return_pkts_in=True
	Should Not Contain			${rxbytes}				ERROR
	Set Suite Variable			${INIT_TX2}				${txbytes}
	Set Suite Variable			${INIT_RX2}				${rxbytes}
	Report					tx:${txbytes},rx:${rxbytes}


Check ASA Environment
	Set Suite Variable	${ftd_IP}			%{ftd_IP}
        ${is_set}=              Run KeyWord And Return Status   Variable Should Exist                   \${ftd_IP}
        Run Keyword Unless      ${is_set}                       Fatal Error                             ASA device address is not defined
	Set Suite Variable	${fmc_IP}			%{fmc_IP}
        ${is_set}=              Run KeyWord And Return Status   Variable Should Exist                   \${fmc_IP}
        Run Keyword Unless      ${is_set}                       Fatal Error                             FMC address is not defined
        Set Topology Variable

