Documentation         # Test Case for Ruleset Performance Balanced Category

*** Settings ***
Resource		resource_keywords_NSX.txt
Library			SSHLibrary
Library                 OperatingSystem
Library                 BuiltIn
Library                 String
Library                 Collections
Library			scwxCorelib.Mail		${TestEnvironment}		${ATF_User}
Library			scwxNSXlib.VulnDB		${TestEnvironment}		${ATF_User}
Library                 scwxNSXlib.NSX			${TestEnvironment}              ${ATF_User}
Library                 scwxBPlib2.BreakingPoint        ${TestEnvironment}      	${ATF_User}     ${VarFile}
Library                 scwxDCIMlib.PathFinder          ${TestEnvironment}      	${ATF_User}     ${VarFile}
Suite Setup		Reserve Resources		Breaking Point	
Suite Teardown		Release Resource and Report Results	

*** Variables ***
${POLICY}			1
${INCIDENT_CNT}			0
${TEST_INCIDENTS}		""
${MIN_THROUGHPUT_10G}		1280	
${MAX_LATENCY_10G}		800
${BENIGN_TRAFFIC_10G}		NSXNN			#NSX_10G_App_Mix
${MAX_DROPPED_PACKETS_10G}	0
${MAX_PCNT_CPU}			10.0
${MAX_PCNT_MEMORY}		0.4
${RULESET_DIFFS}		"Undefined"
${PREAMBLE}			NSX-T/Suricata ruleset test on version
${CPU_PCNT_INCREASE}		NA
${CAUSE_OF_FAILURE}		No Problem Found
${NSX_NVERSION}			Unknown
${NSX_PVERSION}			Unknown
${SAMPLES}			/var/www/html/atfweb/Ruleset_Performance/Ruleset_Performance/history/NSX-T/${TestEnvironment.capitalize()}
${HISTORY}			No performace history was logged due to test failure
${AVG_TX_DATA_RATE}		0.0

*** Test Case ***

Download Ruleset From VulnDB
	${latest}		${previous}=						Get Latest Suricata RS Version
        ${success}=             Run Keyword and Return Status                           Should Not Contain              ${latest}	ERROR
	Set Suite Variable	${targetRuleset}					${latest}
	Run Keyword Unless	${success}						Fatal Error			${latest}
	Set Suite Variable	${FIRST}						${previous}
	Set Suite Variable	${SECOND}						${latest}
	Log			Latest suricata ruleset version is: ${latest}
	Set Test Message	Latest Suricata Ruleset Version is: ${latest}
	Set Suite Variable	${LATEST_RULESET}					${latest}
	${rsp}=			Download Suricata Ruleset				${latest}
	Set Test Message	${rsp}							append=True
	${success}=		Run Keyword and Return Status				Should Not Contain		${rsp}		ERROR
	Run Keyword Unless	${success}						Fatal Error			${rsp}
	Log			${rsp}

Notify Start Of Test via Email
	Set Mail Subject	Starting ${PREAMBLE} "${targetRuleset}-"
	${NSX_Version}=		Get NSX Versions 
	Set Suite Variable	${NSX_NVERSION}						${NSX_Version["node_version"]}
	Set Suite Variable	${NSX_PVERSION}						${NSX_Version["product_version"]}
	Append Config		NSX Version: ${NSX_Version}
	${resp}=		Mail Report
	Log			${resp}
	Set Test Message	${resp}


Verify Current State of Target 
	Log			Test is running in ${TestEnvironment}
	${uptime}=		Get NSX Uptime
	Set Test Message	NSX uptime: ${uptime}
	Log			NSX uptime: ${uptime}
	${result}=		Configure NSX Bridge VM
	Log			${result}
	Set Test Message	${result}						append=True
	${success}=		Run Keyword and Return Status				Should Not Contain		${result}	ERROR
	Run Keyword Unless      ${success}                                              Fatal Error                     ${status}
	
Download VulnDb Ruleset Diffs
	${diffs}=		Get Suricata Ruleset Diffs				${LATEST_RULESET}
	Set Test Message	${diffs}
	LOG			${diffs}
	Set Suite Variable	${RULESET_DIFFS}					${diffs}
	

#Push Ruleset To NSX
#	${rsp}=			Deploy Ruleset to NSX Manager
#	${success}=             Run Keyword and Return Status                           Should Not Contain              ${rsp}          ERROR
#	Run Keyword Unless      ${success}                                              Fatal Error                     ${rsp}
#	Log                     ${rsp}
	

#Verify NSX Is On New Version
#	Verify NSX Version
#	Validate and Log NSX Configuration

Get PreTraffic Metrics
	${iface_info}=		Get NSX Interface Info
	Log			${iface_info}
	${total_mem}		${used_mem}				${limit}=	Get NSX Memory Usage
	Set Suite Variable	${PRE_TEST_MEMORY_USAGE}		${used_mem}
	Log			${used_mem}Mb out of ${total_mem}Mb in use
	Set Test Message	Pre-test memory: ${used_mem}Mb out of ${total_mem} in use 

Run Benign Traffic
	Set Suite Variable      ${MIN_THROUGHPUT}                       ${MIN_THROUGHPUT_10G}
	Set Suite Variable      ${MAX_LATENCY}                          ${MAX_LATENCY_10G}
	Set Suite Variable      ${MAX_DROPPED_PACKETS}                  ${MAX_DROPPED_PACKETS_10G}
	Set Test Message        Expecting minimum thoughput: ${MIN_THROUGHPUT} and maximum latency: ${MAX_LATENCY}
	${perf_test}=           Set Variable                            ${BENIGN_TRAFFIC_10G}
        ${cpu_usage}            ${previous}=                            Get NSX CPU Usage                       used-time
	Set Test Message	\nPre-traffic CPU usage:${cpu_usage}	append=True
        Set Suite Variable      ${PRE_TRAFFIC_CPU_USAGE}                ${cpu_usage}
        Log                     ${cpu_usage}
	${link_state}=		Get VMNIC Link State
	Log			${link_state}
	${success}=             Run Keyword and Return Status           Should Not Contain              ${link_state}	Down
	Run Keyword Unless      ${success}				Set Suite Variable		${CAUSE_OF_FAILURE}	${link_state}Link is Down
	Run Keyword Unless      ${success}                             	Fatal Error                     ${link_state}Link is Down!!

	${results}=             Run Breaking Point Traffic              ${perf_test}

	${link_state}=		Get VMNIC Link State
	Log			${link_state}
	${success}=             Run Keyword and Return Status           Should Not Contain              ${link_state}	Down
	Run Keyword Unless      ${success}				Set Suite Variable		${CAUSE_OF_FAILURE}	${link_state}Link is Down
	Run Keyword Unless      ${success}                              Fatal Error                     ${link_state}Link is Down!!

        ${cpu_usage}            ${previous}=                            Get NSX CPU Usage               used-time
	Set Suite Variable 	${POST_TRAFFIC_CPU_USAGE}		${cpu_usage}
	Set Test Message        \nPost-traffic CPU usage:${cpu_usage}	append=True
        Log                     ${cpu_usage}


	${false_string}=        Get Lines Containing String             ${results}                              testResult=failed
	${BPresults}=           Remove String                           ${results}                              ${false_string}
	${false_string}=        Get Lines Containing String             ${BPresults}                            testResult=passed
	${BPresults}=           Remove String                           ${BPresults}                            ${false_string}
	Set Suite Variable      ${BP_Traffic_Results}                   ${BPresults}
	Set Test Message	\nBP Traffic Result:\n${BPresults}	append=True

Get PostTraffic Metrics
	${post_cpu_usage}=	Convert To Number			${POST_TRAFFIC_CPU_USAGE}	2
	${pre_cpu_usage}=	Convert To Number			${PRE_TRAFFIC_CPU_USAGE}	2
	${diff_cpu}=		Evaluate				$post_cpu_usage-$pre_cpu_usage
	${pcnt_cpu_diff}=	Evaluate				($diff_cpu*100)/${PRE_TRAFFIC_CPU_USAGE}
	Log			${pcnt_cpu_diff}
	Set Test Message	Pcnt CPU Usage increase: ${pcnt_cpu_diff}
	${pcnt_cpu_diff}=	Convert To Number			${pcnt_cpu_diff}		2
	Set Suite Variable	${CPU_PCNT_INCREASE}			${pcnt_cpu_diff}
	Run Keyword If		$MAX_PCNT_CPU<=$pcnt_cpu_diff		Set Suite Variable		${CAUSE_OF_FAILURE}	CPU usage of ${pcnt_cpu_diff} exceeded limit
	${failed}=              Run Keyword and Return Status           Should Not Contain              ${CAUSE_OF_FAILURE}     No Problem Found

	${total_mem}		${used_mem}				${limit}=	Get NSX Memory Usage
	${post_usage}=		Convert To Number			${used_mem}			2
	${pre_usage}=		Convert To Number			${PRE_TEST_MEMORY_USAGE}	2
	${diff_mem}=		Evaluate				${post_usage}-${pre_usage}
	${pcnt_mem_diff}=	Evaluate				(${diff_mem}*100)/${pre_usage}
	${pcnt_mem_diff}=	Convert To Number			${pcnt_mem_diff}		2
	Log                     ${pcnt_mem_diff}
	Set Suite Variable	${MEM_PCNT_USAGE}			${pcnt_mem_diff}
	Run Keyword If          ${MAX_PCNT_CPU}<=${pcnt_mem_diff}	Set Suite Variable		${CAUSE_OF_FAILURE}	Memory usage of ${pcnt_mem_diff} exceeded limit
	${failed}=		Run Keyword and Return Status           Should Not Contain              ${CAUSE_OF_FAILURE}     No Problem Found
	Log			${used_mem}Mb out of ${total_mem} in use
	Set Test Message	Post-traffic memory: ${used_mem}Mb out of ${total_mem}Mb in use		append=True
	Set Test Message	Post-traffic CPU usage: ${POST_TRAFFIC_CPU_USAGE}			append=True
	Set Test Message	CPU usage increase: ${pcnt_cpu_diff}					append=True
	Run Keyword If          ${failed}                               Fatal Error                     ${CAUSE_OF_FAILURE}


Evaluate Post Traffic Measurments
	Log			${BP_Traffic_Results}
	${result}=		Parse BP Results			${BP_Traffic_Results}
	#Verify Results Are Within Acceptable Limits			${BP_Traffic_Results}
	#Capture Metrics for Standard Deviation Samples			${AVG_TX_DATA_RATE}			${AVG_LATENCY}


*** Keywords ***

Capture Metrics for Standard Deviation Samples    	                [Arguments]             ${throughput}           ${latency}	${result}
        ${timestamp}=           Run                     	        date "+%04Y.%02m.%02dT%02H:%02M:%02S"
        ${content}=             Set Variable                    	${timestamp},${NSX_NVERSION},${targetRuleset},${throughput},${latency},${result}\n
        Append To File          ${SAMPLES}/performance_samples.csv	${content}
        ${resp}			${perf_history}=						Run Keyword And Ignore Error   		Publish Performance Results
	Log			${resp}, ${perf_history}
	Run Keyword If		"${resp}"=="PASS"						Set Suite Variable			${HISTORY}	${perf_history}
	Run Keyword Unless	"${resp}"=="PASS"						Set Suite Variable			${HISTORY}	${resp}:${perf_history}	

Parse BP Results		[Arguments]				${results}
        ${avgTx_line}=          Get Lines Containing String             ${results}                      Average Tx Data Rate Mb/s,
        ${avg_Tx_data_rate}=    Replace String                          ${avgTx_line}                   Average Tx Data Rate Mb/s,      ${EMPTY}
        Should Not Be Empty     ${avg_Tx_data_rate}                     Breaking Point returned a null report
        ${avg_tx}=		Convert To Number                       ${avg_Tx_data_rate}
	Set Suite Variable	${AVG_TX_DATA_RATE}			${avg_tx}
        ${avgRx_line}=          Get Lines Containing String             ${results}                      Average Rx Data Rate Mb/s,
        ${avg_Rx_data_rate}=    Replace String                          ${avgRx_line}                   Average Rx Data Rate Mb/s,      ${EMPTY}
        ${AVG_RX_DATA_RATE}=    Convert To Number                       ${avg_Rx_data_rate}
        ${avg_Lat_line}=        Get Lines Containing String             ${results}                      Average,
 	Run Keyword If		"${avg_Lat_line}"=="${EMPTY}"		Fatal Error			Bad Traffic Data From Breaking Point
        ${avg_Lat_data_rate}=   Replace String                          ${avg_Lat_line}                 Average,                        ${EMPTY}
        ${AVG_LATENCY}=         Convert To Number                       ${avg_Lat_data_rate.lstrip('~')}
        ${min_tp}=              Convert To Number                       ${MIN_THROUGHPUT}
        ${max_lat}=             Convert To Number                       ${MAX_LATENCY}
        Set Suite Variable      ${AVG_TX_DATA_RATE}	                ${AVG_TX_DATA_RATE}
        Set Suite Variable      ${AVG_RX_DATA_RATE}     	        ${AVG_RX_DATA_RATE}
        Set Suite Variable      ${AVG_LATENCY}                  	${AVG_LATENCY}
        Set Suite Variable      ${RESULTS}                        	${results}\n
        ${bl_tx}=               Convert To Integer                      ${AVG_TX_DATA_RATE}
        ${bl_rx}=               Convert To Integer                      ${AVG_RX_DATA_RATE}
        ${bl_lat}=              Convert To Integer                      ${AVG_LATENCY}
        Run Keyword If          $bl_tx < $min_tp                        Set Suite Variable              ${CAUSE_OF_FAILURE}     Baseline avg. Tx rate of ${AVG_TX_DATA_RATE} is too low
        Run Keyword If          $bl_rx < $min_tp                        Set Suite Variable              ${CAUSE_OF_FAILURE}     Baseline avg. Rx rate of ${AVG_RX_DATA_RATE} is too low
        Run Keyword If          $bl_lat > $max_lat                      Set Suite Variable              ${CAUSE_OF_FAILURE}     Baseline avg. latency of ${AVG_LATENCY} is to high

	${failed}=              Run Keyword and Return Status           Should Not Contain              ${CAUSE_OF_FAILURE}     No Problem Found
	Run Keyword If		${failed}				Fatal Error			${CAUSE_OF_FAILURE}


Verify Results Are Within Acceptable Limits                             [Arguments]                     ${results}

        ${avgTx_line}=          Get Lines Containing String             ${results}                      Average Tx Data Rate Mb/s,
        ${avg_Tx_data_rate}=    Replace String                          ${avgTx_line}                   Average Tx Data Rate Mb/s,      ${EMPTY}
        Should Not Be Empty     ${avg_Tx_data_rate}                     Breaking Point returned a null report
        ${AVG_TX_DATA_RATE}=    Convert To Number                       ${avg_Tx_data_rate}
        ${avgRx_line}=          Get Lines Containing String             ${results}                      Average Rx Data Rate Mb/s,
        ${avg_Rx_data_rate}=    Replace String                          ${avgRx_line}                   Average Rx Data Rate Mb/s,      ${EMPTY}
        ${AVG_RX_DATA_RATE}=    Convert To Number                       ${avg_Rx_data_rate}
        ${avg_Lat_line}=        Get Lines Containing String             ${results}                      Average,
        ${avg_Lat_data_rate}=   Replace String                          ${avg_Lat_line}                 Average,                        ${EMPTY}
        ${have_latency}=        Run Keyword and Return Status           Should Not Be Empty             ${avg_Lat_data_rate}
        Run Keyword Unless      ${have_latency}                         Set Suite Variable              ${CAUSE_OF_FAILURE}             Breaking Point reported no latency value
        Run Keyword Unless      ${have_latency}                         Fatal Error                     ${CAUSE_OF_FAILURE}
        ${AVG_LATENCY}=         Convert To Number                       ${avg_Lat_data_rate.lstrip('~')}

        ${min_throughput}=      Convert To Number                       ${MIN_THROUGHPUT}

        ${max_latency}=         Convert To Number                       ${MAX_LATENCY}
        #${bl_tx}=              Convert To Integer                      ${AVG_TX_DATA_RATE}
        #${min_throughput}=     Evaluate                                $bl_tx * 0.95

        Set Suite Variable      ${PERFORMANCE_RESULTS}                  ${results}\n
        Run Keyword If          $AVG_TX_DATA_RATE < $min_throughput     Set Suite Variable              ${CAUSE_OF_FAILURE}     Average Tx rate of ${AVG_TX_DATA_RATE} is too low
        Run Keyword If          $AVG_RX_DATA_RATE < $min_throughput     Set Suite Variable              ${CAUSE_OF_FAILURE}     Average Rx rate of ${AVG_RX_DATA_RATE} is too low
        Run Keyword If          $AVG_LATENCY > $max_latency             Set Suite Variable              ${CAUSE_OF_FAILURE}     Average Latency of ${AVG_LATENCY} is too high
        ${failed}=              Run Keyword and Return Status           Should Not Contain              ${CAUSE_OF_FAILURE}     No Problem Found
        Capture Metrics for Standard Deviation Samples                  ${AVG_TX_DATA_RATE}             ${AVG_LATENCY}          ${failed}
        Should Contain          ${CAUSE_OF_FAILURE}                     No Problem Found                ${CAUSE_OF_FAILURE}




Release Resource and Report Results
	Release Resources
	Run Keyword If All Critical Tests Passed	Email Test Has Passed
	Run Keyword If Any Critical Tests Failed	Email Test Has Failed
	

Email Test Has Passed
        Capture Metrics for Standard Deviation Samples           			       ${AVG_TX_DATA_RATE}             ${AVG_LATENCY}          PASSED
	Set Mail Subject	${PREAMBLE} ${targetRuleset} has PASSED				catenate=True
	Log to Mail             ${RULESET_DIFFS}                                               	title=Ruleset Differences between ${FIRST} and ${SECOND}
        Run Keyword If          ${INCIDENT_CNT}==0      Log To Mail                             There were no incidents         title=Incidents during the test:
        Run Keyword Unless      ${INCIDENT_CNT}==0      Log To Mail                             ${TEST_INCIDENTS}               title=Incidents during the test:
	Log To Mail		${BP_Traffic_Results}			`			title=Breaking Point Results
	Log To Mail		CPU: ${CPU_PCNT_INCREASE}%, Memory: ${MEM_PCNT_USAGE}%		title=Resource usage increase under traffic load
	Log To Mail		Test Report:		reportfile				title=Report File
	Log To Mail		Test Log:		logfile					title=Log File
	Log To Mail		${HISTORY}							title=Performance History
	${resp}=		Mail Report		attach=reportfile,logfile
	Log			${resp} 

Insert Report Details
	${defined}=             Run Keyword And Return Status                                   Check Teardown Variables
	Run Keyword Unless      ${defined}                                                      Return From Keyword
	Log to Mail             ${RULESET_DIFFS}                                                title=Ruleset Differences between ${FIRST} and ${SECOND}

	
Email Test Has Failed
        Capture Metrics for Standard Deviation Samples           			       ${AVG_TX_DATA_RATE}             ${AVG_LATENCY}          FAILED
	Set Mail Subject	${PREAMBLE} ${targetRuleset} has FAILED				catenate=True
	Log To Mail		${CAUSE_OF_FAILURE}						title=Cause of failure
	Insert Report Details
        Run Keyword If          ${INCIDENT_CNT}==0      Log To Mail                             There were no incidents         title=Incidents during the test:
        Run Keyword Unless      ${INCIDENT_CNT}==0      Log To Mail                             ${TEST_INCIDENTS}               title=Incidents during the test:
	Log To Mail		Test Report:		reportfile				title=Report File
	Log To Mail		${LOGFILE}			
	Log To Mail		Test Log:		logfile					title=Log File
	Log To Mail		${HISTORY}							title=Performance History
	${resp}=		Mail Report		attach=reportfile,logfile
	Log			${resp}

